<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="The CloudNativePG Contributors" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Appendix C - Common object stores for backups - CloudNativePG v1.26</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../css/override.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Appendix C - Common object stores for backups";
        var mkdocs_page_input_path = "appendixes/object_stores.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> CloudNativePG v1.26
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">CloudNativePG</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../before_you_start/">Before You Start</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../use_cases/">Use cases</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../architecture/">Architecture</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../installation_upgrade/">Installation and upgrades</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../quickstart/">Quickstart</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../image_catalog/">Image Catalog</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../bootstrap/">Bootstrap</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../database_import/">Importing Postgres databases</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../security/">Security</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../instance_manager/">Postgres instance manager</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../scheduling/">Scheduling</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../resource_management/">Resource management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../failure_modes/">Failure Modes</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../rolling_update/">Rolling Updates</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../replication/">Replication</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../logical_replication/">Logical Replication</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../backup/">Backup</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../wal_archiving/">WAL archiving</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../recovery/">Recovery</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../service_management/">Service Management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../postgresql_conf/">PostgreSQL Configuration</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../declarative_role_management/">PostgreSQL Role Management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../declarative_database_management/">PostgreSQL Database Management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../tablespaces/">Tablespaces</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../operator_conf/">Operator configuration</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../cluster_conf/">Instance pod configuration</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../storage/">Storage</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../labels_annotations/">Labels and annotations</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../monitoring/">Monitoring</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../logging/">Logging</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../certificates/">Certificates</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../ssl_connections/">Client TLS/SSL connections</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../applications/">Connecting from an application</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../connection_pooling/">Connection pooling</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../replica_cluster/">Replica clusters</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../kubernetes_upgrade/">Kubernetes Upgrade and Maintenance</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../postgres_upgrades/">PostgreSQL Upgrades</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../kubectl-plugin/">Kubectl Plugin</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../failover/">Automated failover</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../troubleshooting/">Troubleshooting</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../fencing/">Fencing</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../declarative_hibernation/">Declarative hibernation</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../postgis/">PostGIS</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../e2e/">End-to-End Tests</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../container_images/">Container Image Requirements</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../operator_capability_levels/">Operator capability levels</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../controller/">Custom Pod Controller</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../samples/">Examples</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../networking/">Networking</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../benchmarking/">Benchmarking</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../faq/">Frequently Asked Questions (FAQ)</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../cloudnative-pg.v1/">API Reference</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../supported_releases/">Supported releases</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../preview_version/">Preview Versions</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../release_notes/">Release notes</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">CNCF Projects Integrations</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../cncf-projects/external-secrets/">External Secrets</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Appendixes</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../backup_volumesnapshot/">Appendix A - Backup on volume snapshots</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../backup_barmanobjectstore/">Appendix B - Backup on object stores</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Appendix C - Common object stores for backups</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#aws-s3">AWS S3</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#aws-access-key">AWS Access key</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#iam-role-for-service-account-irsa">IAM Role for Service Account (IRSA)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#s3-lifecycle-policy">S3 lifecycle policy</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#other-s3-compatible-object-storages-providers">Other S3-compatible Object Storages providers</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#using-object-storage-with-a-private-ca">Using Object Storage with a private CA</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#azure-blob-storage">Azure Blob Storage</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#other-azure-blob-storage-compatible-providers">Other Azure Blob Storage compatible providers</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#google-cloud-storage">Google Cloud Storage</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#running-inside-google-kubernetes-engine">Running inside Google Kubernetes Engine</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#using-authentication">Using authentication</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">CloudNativePG v1.26</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Appendixes</li>
      <li class="breadcrumb-item active">Appendix C - Common object stores for backups</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="appendix-c-common-object-stores-for-backups">Appendix C - Common object stores for backups</h1>
<!-- SPDX-License-Identifier: CC-BY-4.0 -->

<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>As of CloudNativePG 1.26, <strong>native Barman Cloud support is deprecated</strong> in
favor of the <strong>Barman Cloud Plugin</strong>. While the native integration remains
functional for now, we strongly recommend beginning a gradual migration to
the plugin-based interface after appropriate testing. The Barman Cloud
Plugin documentation describes
<a href="https://cloudnative-pg.io/plugin-barman-cloud/docs/object_stores/">how to use common object stores</a>.</p>
</div>
<p>You can store the <a href="../../backup/">backup</a> files in any service that is supported
by the Barman Cloud infrastructure. That is:</p>
<ul>
<li><a href="#aws-s3">Amazon S3</a></li>
<li><a href="#azure-blob-storage">Microsoft Azure Blob Storage</a></li>
<li><a href="#google-cloud-storage">Google Cloud Storage</a></li>
</ul>
<p>You can also use any compatible implementation of the supported services.</p>
<p>The required setup depends on the chosen storage provider and is
discussed in the following sections.</p>
<h2 id="aws-s3">AWS S3</h2>
<p><a href="https://aws.amazon.com/s3/">AWS Simple Storage Service (S3)</a> is
a very popular object storage service offered by Amazon.</p>
<p>As far as CloudNativePG backup is concerned, you can define the permissions to
store backups in S3 buckets in two ways:</p>
<ul>
<li>If CloudNativePG is running in EKS. you may want to use the
  <a href="https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html">IRSA authentication method</a></li>
<li>Alternatively, you can use the <code>ACCESS_KEY_ID</code> and <code>ACCESS_SECRET_KEY</code> credentials</li>
</ul>
<h3 id="aws-access-key">AWS Access key</h3>
<p>You will need the following information about your environment:</p>
<ul>
<li>
<p><code>ACCESS_KEY_ID</code>: the ID of the access key that will be used
  to upload files into S3</p>
</li>
<li>
<p><code>ACCESS_SECRET_KEY</code>: the secret part of the access key mentioned above</p>
</li>
<li>
<p><code>ACCESS_SESSION_TOKEN</code>: the optional session token, in case it is required</p>
</li>
</ul>
<p>The access key used must have permission to upload files into
the bucket. Given that, you must create a Kubernetes secret with the
credentials, and you can do that with the following command:</p>
<pre><code class="language-sh">kubectl create secret generic aws-creds \
  --from-literal=ACCESS_KEY_ID=&lt;access key here&gt; \
  --from-literal=ACCESS_SECRET_KEY=&lt;secret key here&gt;
# --from-literal=ACCESS_SESSION_TOKEN=&lt;session token here&gt; # if required
</code></pre>
<p>The credentials will be stored inside Kubernetes and will be encrypted
if encryption at rest is configured in your installation.</p>
<p>Once that secret has been created, you can configure your cluster like in
the following example:</p>
<pre><code class="language-yaml">apiVersion: postgresql.cnpg.io/v1
kind: Cluster
[...]
spec:
  backup:
    barmanObjectStore:
      destinationPath: &quot;&lt;destination path here&gt;&quot;
      s3Credentials:
        accessKeyId:
          name: aws-creds
          key: ACCESS_KEY_ID
        secretAccessKey:
          name: aws-creds
          key: ACCESS_SECRET_KEY
</code></pre>
<p>The destination path can be any URL pointing to a folder where
the instance can upload the WAL files, e.g.
<code>s3://BUCKET_NAME/path/to/folder</code>.</p>
<h3 id="iam-role-for-service-account-irsa">IAM Role for Service Account (IRSA)</h3>
<p>In order to use IRSA you need to set an <code>annotation</code> in the <code>ServiceAccount</code> of
the Postgres cluster.</p>
<p>We can configure CloudNativePG to inject them using the <code>serviceAccountTemplate</code>
stanza:</p>
<pre><code class="language-yaml">apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
[...]
spec:
  serviceAccountTemplate:
    metadata:
      annotations:
        eks.amazonaws.com/role-arn: arn:[...]
        [...]
</code></pre>
<h3 id="s3-lifecycle-policy">S3 lifecycle policy</h3>
<p>Barman Cloud writes objects to S3, then does not update them until they are
deleted by the Barman Cloud retention policy. A recommended approach for an S3
lifecycle policy is to expire the current version of objects a few days longer
than the Barman retention policy, enable object versioning, and expire
non-current versions after a number of days. Such a policy protects against
accidental deletion, and also allows for restricting permissions to the
CloudNativePG workload so that it may delete objects from S3 without granting
permissions to permanently delete objects.</p>
<h3 id="other-s3-compatible-object-storages-providers">Other S3-compatible Object Storages providers</h3>
<p>In case you're using S3-compatible object storage, like <strong>MinIO</strong> or
<strong>Linode Object Storage</strong>, you can specify an endpoint instead of using the
default S3 one.</p>
<p>In this example, it will use the <code>bucket</code> of <strong>Linode</strong> in the region
<code>us-east1</code>.</p>
<pre><code class="language-yaml">apiVersion: postgresql.cnpg.io/v1
kind: Cluster
[...]
spec:
  backup:
    barmanObjectStore:
      destinationPath: &quot;s3://bucket/&quot;
      endpointURL: &quot;https://us-east1.linodeobjects.com&quot;
      s3Credentials:
        [...]
</code></pre>
<p>In case you're using <strong>Digital Ocean Spaces</strong>, you will have to use the Path-style syntax.
In this example, it will use the <code>bucket</code> from <strong>Digital Ocean Spaces</strong> in the region <code>SFO3</code>.</p>
<pre><code class="language-yaml">apiVersion: postgresql.cnpg.io/v1
kind: Cluster
[...]
spec:
  backup:
    barmanObjectStore:
      destinationPath: &quot;s3://[your-bucket-name]/[your-backup-folder]/&quot;
      endpointURL: &quot;https://sfo3.digitaloceanspaces.com&quot;
      s3Credentials:
        [...]
</code></pre>
<h3 id="using-object-storage-with-a-private-ca">Using Object Storage with a private CA</h3>
<p>Suppose you configure an Object Storage provider which uses a certificate
signed with a private CA, for example when using MinIO via HTTPS. In that case,
you need to set the option <code>endpointCA</code> inside <code>barmanObjectStore</code> referring
to a secret containing the CA bundle, so that Barman can verify the certificate
correctly.
You can find instructions on creating a secret using your cert files in the
<a href="../../certificates/#example">certificates</a> document.
Once you have created the secret, you can populate the <code>endpointCA</code> as in the
following example:</p>
<pre><code class="language-yaml">apiVersion: postgresql.cnpg.io/v1
kind: Cluster
[...]
spec:
  [...]
  backup:
    barmanObjectStore:
      endpointURL: &lt;myEndpointURL&gt;
      endpointCA:
        name: my-ca-secret
        key: ca.crt
</code></pre>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you want ConfigMaps and Secrets to be <strong>automatically</strong> reloaded by instances, you can
add a label with key <code>cnpg.io/reload</code> to the Secrets/ConfigMaps. Otherwise, you will have to reload
the instances using the <code>kubectl cnpg reload</code> subcommand.</p>
</div>
<h2 id="azure-blob-storage">Azure Blob Storage</h2>
<p><a href="https://azure.microsoft.com/en-us/services/storage/blobs/">Azure Blob Storage</a> is the
object storage service provided by Microsoft.</p>
<p>In order to access your storage account for backup and recovery of
CloudNativePG managed databases, you will need one of the following
combinations of credentials:</p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/azure/storage/common/storage-configure-connection-string#configure-a-connection-string-for-an-azure-storage-account">Connection String</a></li>
<li>Storage account name and <a href="https://docs.microsoft.com/en-us/azure/storage/common/storage-account-keys-manage">Storage account access key</a></li>
<li>Storage account name and <a href="https://docs.microsoft.com/en-us/azure/storage/blobs/sas-service-create">Storage account SAS Token</a></li>
<li>Storage account name and <a href="https://azure.github.io/azure-workload-identity/docs/introduction.html">Azure AD Workload Identity</a>
properly configured.</li>
</ul>
<p>Using <strong>Azure AD Workload Identity</strong>, you can avoid saving the credentials into a Kubernetes Secret,
and have a Cluster configuration adding the <code>inheritFromAzureAD</code> as follows:</p>
<pre><code class="language-yaml">apiVersion: postgresql.cnpg.io/v1
kind: Cluster
[...]
spec:
  backup:
    barmanObjectStore:
      destinationPath: &quot;&lt;destination path here&gt;&quot;
      azureCredentials:
        inheritFromAzureAD: true
</code></pre>
<p>On the other side, using both <strong>Storage account access key</strong> or <strong>Storage account SAS Token</strong>,
the credentials need to be stored inside a Kubernetes Secret, adding data entries only when
needed. The following command performs that:</p>
<pre><code class="language-sh">kubectl create secret generic azure-creds \
  --from-literal=AZURE_STORAGE_ACCOUNT=&lt;storage account name&gt; \
  --from-literal=AZURE_STORAGE_KEY=&lt;storage account key&gt; \
  --from-literal=AZURE_STORAGE_SAS_TOKEN=&lt;SAS token&gt; \
  --from-literal=AZURE_STORAGE_CONNECTION_STRING=&lt;connection string&gt;
</code></pre>
<p>The credentials will be encrypted at rest, if this feature is enabled in the used
Kubernetes cluster.</p>
<p>Given the previous secret, the provided credentials can be injected inside the cluster
configuration:</p>
<pre><code class="language-yaml">apiVersion: postgresql.cnpg.io/v1
kind: Cluster
[...]
spec:
  backup:
    barmanObjectStore:
      destinationPath: &quot;&lt;destination path here&gt;&quot;
      azureCredentials:
        connectionString:
          name: azure-creds
          key: AZURE_CONNECTION_STRING
        storageAccount:
          name: azure-creds
          key: AZURE_STORAGE_ACCOUNT
        storageKey:
          name: azure-creds
          key: AZURE_STORAGE_KEY
        storageSasToken:
          name: azure-creds
          key: AZURE_STORAGE_SAS_TOKEN
</code></pre>
<p>When using the Azure Blob Storage, the <code>destinationPath</code> fulfills the following
structure:</p>
<pre><code class="language-sh">&lt;http|https&gt;://&lt;account-name&gt;.&lt;service-name&gt;.core.windows.net/&lt;resource-path&gt;
</code></pre>
<p>where <code>&lt;resource-path&gt;</code> is <code>&lt;container&gt;/&lt;blob&gt;</code>. The <strong>account name</strong>,
which is also called <strong>storage account name</strong>, is included in the used host name.</p>
<h3 id="other-azure-blob-storage-compatible-providers">Other Azure Blob Storage compatible providers</h3>
<p>If you are using a different implementation of the Azure Blob Storage APIs,
the <code>destinationPath</code> will have the following structure:</p>
<pre><code class="language-sh">&lt;http|https&gt;://&lt;local-machine-address&gt;:&lt;port&gt;/&lt;account-name&gt;/&lt;resource-path&gt;
</code></pre>
<p>In that case, <code>&lt;account-name&gt;</code> is the first component of the path.</p>
<p>This is required if you are testing the Azure support via the Azure Storage
Emulator or <a href="https://github.com/Azure/Azurite">Azurite</a>.</p>
<h2 id="google-cloud-storage">Google Cloud Storage</h2>
<p>Currently, the CloudNativePG operator supports two authentication methods for
<a href="https://cloud.google.com/storage/">Google Cloud Storage</a>:</p>
<ul>
<li>the first one assumes that the pod is running inside a Google Kubernetes Engine cluster</li>
<li>the second one leverages the environment variable <code>GOOGLE_APPLICATION_CREDENTIALS</code></li>
</ul>
<h3 id="running-inside-google-kubernetes-engine">Running inside Google Kubernetes Engine</h3>
<p>When running inside Google Kubernetes Engine you can configure your backups to
simply rely on <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity">Workload Identity</a>,
without having to set any credentials. In particular, you need to:</p>
<ul>
<li>set <code>.spec.backup.barmanObjectStore.googleCredentials.gkeEnvironment</code> to <code>true</code></li>
<li>set the <code>iam.gke.io/gcp-service-account</code> annotation in the <code>serviceAccountTemplate</code> stanza</li>
</ul>
<p>Please use the following example as a reference:</p>
<pre><code class="language-yaml">apiVersion: postgresql.cnpg.io/v1
kind: Cluster
[...]
spec:
  [...]
  backup:
    barmanObjectStore:
      destinationPath: &quot;gs://&lt;destination path here&gt;&quot;
      googleCredentials:
        gkeEnvironment: true

  serviceAccountTemplate:
    metadata:
      annotations:
        iam.gke.io/gcp-service-account:  [...].iam.gserviceaccount.com
        [...]
</code></pre>
<h3 id="using-authentication">Using authentication</h3>
<p>Following the <a href="https://cloud.google.com/docs/authentication/getting-started">instruction from Google</a>
you will get a JSON file that contains all the required information to authenticate.</p>
<p>The content of the JSON file must be provided using a <code>Secret</code> that can be created
with the following command:</p>
<pre><code class="language-shell">kubectl create secret generic backup-creds --from-file=gcsCredentials=gcs_credentials_file.json
</code></pre>
<p>This will create the <code>Secret</code> with the name <code>backup-creds</code> to be used in the yaml file like this:</p>
<pre><code class="language-yaml">apiVersion: postgresql.cnpg.io/v1
kind: Cluster
[...]
spec:
  backup:
    barmanObjectStore:
      destinationPath: &quot;gs://&lt;destination path here&gt;&quot;
      googleCredentials:
        applicationCredentials:
          name: backup-creds
          key: gcsCredentials
</code></pre>
<p>Now the operator will use the credentials to authenticate against Google Cloud Storage.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>This way of authentication will create a JSON file inside the container with all the needed
information to access your Google Cloud Storage bucket, meaning that if someone gets access to the pod
will also have write permissions to the bucket.</p>
</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../backup_barmanobjectstore/" class="btn btn-neutral float-left" title="Appendix B - Backup on object stores"><span class="icon icon-circle-arrow-left"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>Copyright Â© CloudNativePG a Series of LF Projects, LLC</p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../backup_barmanobjectstore/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
