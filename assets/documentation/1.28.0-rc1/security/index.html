<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="The CloudNativePG Contributors" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Security - CloudNativePG v1.28.0-rc1</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/override.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Security";
        var mkdocs_page_input_path = "security.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> CloudNativePG v1.28.0-rc1
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">CloudNativePG</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../before_you_start/">Before You Start</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../use_cases/">Use cases</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../architecture/">Architecture</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../installation_upgrade/">Installation and upgrades</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../quickstart/">Quickstart</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../image_catalog/">Image Catalog</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../bootstrap/">Bootstrap</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../database_import/">Importing Postgres databases</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">Security</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#code">Code</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#container">Container</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#image-signatures">Image Signatures</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#attestations">Attestations</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#guidelines-and-frameworks-for-container-security">Guidelines and Frameworks for Container Security</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#cluster">Cluster</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#role-based-access-control-rbac">Role Based Access Control (RBAC)</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#deployments-and-clusterrole-resources">Deployments and ClusterRole Resources</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#why-are-clusterrole-permissions-needed">Why Are ClusterRole Permissions Needed?</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#calls-to-the-api-server-made-by-the-instance-manager">Calls to the API server made by the instance manager</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#pod-and-container-security-contexts">Pod and Container Security Contexts</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#customizing-security-contexts">Customizing Security Contexts</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#security-context-constraints">Security Context Constraints</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#restricting-pod-access-using-apparmor">Restricting Pod access using AppArmor</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#network-policies">Network Policies</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#exposed-ports">Exposed Ports</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#postgresql">PostgreSQL</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#storage">Storage</a>
    </li>
        </ul>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../instance_manager/">Postgres instance manager</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../scheduling/">Scheduling</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../resource_management/">Resource management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../failure_modes/">Failure Modes</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../rolling_update/">Rolling Updates</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../replication/">Replication</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../logical_replication/">Logical Replication</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../backup/">Backup</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../wal_archiving/">WAL archiving</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../recovery/">Recovery</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../service_management/">Service Management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../postgresql_conf/">PostgreSQL Configuration</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../declarative_role_management/">PostgreSQL Role Management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../declarative_database_management/">PostgreSQL Database Management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../tablespaces/">Tablespaces</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../operator_conf/">Operator configuration</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../cluster_conf/">Instance pod configuration</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../storage/">Storage</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../labels_annotations/">Labels and annotations</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../monitoring/">Monitoring</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../logging/">Logging</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../certificates/">Certificates</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../ssl_connections/">Client TLS/SSL connections</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../applications/">Connecting from an application</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../connection_pooling/">Connection pooling</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../replica_cluster/">Replica clusters</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../kubernetes_upgrade/">Kubernetes Upgrade and Maintenance</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../postgres_upgrades/">PostgreSQL Upgrades</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../kubectl-plugin/">Kubectl Plugin</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../failover/">Automated failover</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../troubleshooting/">Troubleshooting</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../fencing/">Fencing</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../declarative_hibernation/">Declarative hibernation</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../postgis/">PostGIS</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../e2e/">End-to-End Tests</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../container_images/">Container Image Requirements</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../imagevolume_extensions/">Image Volume Extensions</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../cnpg_i/">CNPG-I</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../operator_capability_levels/">Operator capability levels</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../controller/">Custom Pod Controller</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../samples/">Examples</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../networking/">Networking</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../benchmarking/">Benchmarking</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../faq/">Frequently Asked Questions (FAQ)</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../cloudnative-pg.v1/">API Reference</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../supported_releases/">Supported releases</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../preview_version/">Preview Versions</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../release_notes/">Release notes</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">CNCF Projects Integrations</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../cncf-projects/external-secrets/">External Secrets</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cncf-projects/cilium/">Cilium</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Appendixes</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../appendixes/backup_volumesnapshot/">Appendix A - Backup on volume snapshots</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../appendixes/backup_barmanobjectstore/">Appendix B - Backup on object stores</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../appendixes/object_stores/">Appendix C - Common object stores for backups</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">CloudNativePG v1.28.0-rc1</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Security</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="security">Security</h1>
<!-- SPDX-License-Identifier: CC-BY-4.0 -->

<p>This section contains information about security for CloudNativePG,
that are analyzed at 3 different layers: Code, Container and Cluster.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The information contained in this page must not exonerate you from
performing regular InfoSec duties on your Kubernetes cluster. Please
familiarize yourself with the <a href="https://kubernetes.io/docs/concepts/security/overview/">"Overview of Cloud Native Security"</a>
page from the Kubernetes documentation.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">About the 4C's Security Model</p>
<p>Please refer to <a href="https://www.enterprisedb.com/blog/4cs-security-model-kubernetes">"The 4C’s Security Model in Kubernetes"</a>
blog article to get a better understanding and context of the approach EDB
has taken with security in CloudNativePG.</p>
</div>
<h2 id="code">Code</h2>
<p>CloudNativePG's source code undergoes systematic static analysis, including
checks for security vulnerabilities, using the popular open-source linter for
Go, <a href="https://github.com/golangci/golangci-lint">GolangCI-Lint</a>, directly
integrated into the CI/CD pipeline. GolangCI-Lint can run multiple linters on
the same source code.</p>
<p>The following tools are used to identify security issues:</p>
<ul>
<li>
<p><strong><a href="https://github.com/securego/gosec">Golang Security Checker</a> (<code>gosec</code>):</strong> A
  linter that scans the abstract syntax tree of the source code against a set
  of rules designed to detect known vulnerabilities, threats, and weaknesses,
  such as hard-coded credentials, integer overflows, and SQL injections.
  GolangCI-Lint runs <code>gosec</code> as part of its suite.</p>
</li>
<li>
<p><strong><a href="https://pkg.go.dev/golang.org/x/vuln/cmd/govulncheck">govulncheck</a>:</strong> This
  tool runs in the CI/CD pipeline and reports known vulnerabilities affecting
  Go code or the compiler. If the operator is built with a version of the Go
  compiler containing a known vulnerability, <code>govulncheck</code> will detect it.</p>
</li>
<li>
<p><strong><a href="https://codeql.github.com/">CodeQL</a>:</strong> Provided by GitHub, this tool scans
  for security issues and blocks any pull request with detected
  vulnerabilities. CodeQL is configured to review only Go code, excluding other
  languages in the repository such as Python or Bash.</p>
</li>
<li>
<p><strong><a href="https://snyk.io/">Snyk</a>:</strong> Conducts nightly code scans in a scheduled job
  and generates weekly reports highlighting any new findings related to code
  security and licensing issues.</p>
</li>
</ul>
<p>The CloudNativePG repository has the <em>"Private vulnerability reporting"</em> option
enabled in the <a href="https://github.com/cloudnative-pg/cloudnative-pg/security">Security section</a>.
This feature allows users to safely report security issues that require careful
handling before being publicly disclosed. If you discover any security bug,
please use this medium to report it.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>A failure in the static code analysis phase of the CI/CD pipeline will
block the entire delivery process of CloudNativePG. Every commit must pass all
the linters defined by GolangCI-Lint.</p>
</div>
<h2 id="container">Container</h2>
<p>Every container image in CloudNativePG is automatically built via CI/CD
pipelines after every commit. These images include not only the operator's
image but also the operands' images, specifically for every supported
PostgreSQL version.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>All operand images are automatically and regularly rebuilt by our pipelines
to incorporate the latest security updates at both the base image and package
levels. This ensures that container images distributed to the community receive
<strong>patch-level updates</strong> regularly.</p>
</div>
<p>During the CI/CD process, images are scanned using the following tools:</p>
<ul>
<li><strong><a href="https://github.com/goodwithtech/dockle">Dockle</a>:</strong> Ensures best practices
  in the container build process.</li>
<li><strong><a href="https://snyk.io/">Snyk</a>:</strong> Detects security issues within the container
  and reports findings via the GitHub interface.</li>
</ul>
<h3 id="image-signatures">Image Signatures</h3>
<p>The operator and <a href="https://github.com/cloudnative-pg/postgres-containers">operand
images</a> are
cryptographically signed using <a href="https://github.com/sigstore/cosign">cosign</a>, a
signature tool from <a href="https://www.sigstore.dev/">sigstore</a>.
This process is automated via GitHub Actions and leverages
<a href="https://docs.github.com/en/actions/security-for-github-actions/security-hardening-your-deployments/about-security-hardening-with-openid-connect">short-lived tokens issued through OpenID Connect</a>.</p>
<p>The token issuer is <code>https://token.actions.githubusercontent.com</code>, and the
signing identity corresponds to a GitHub workflow executed under the
<a href="https://github.com/cloudnative-pg/cloudnative-pg/">cloudnative-pg</a> repository.
This workflow uses the <a href="https://github.com/marketplace/actions/cosign-installer">cosign-installer action</a>
to streamline the signing process.</p>
<p>To verify the authenticity of an operator image, use the following <code>cosign</code>
command with the image digest:</p>
<pre><code class="language-shell">cosign verify ghcr.io/cloudnative-pg/cloudnative-pg@sha256:&lt;DIGEST&gt; \
  --certificate-identity-regexp=&quot;^https://github.com/cloudnative-pg/cloudnative-pg/&quot; \
  --certificate-oidc-issuer=&quot;https://token.actions.githubusercontent.com&quot;
</code></pre>
<h3 id="attestations">Attestations</h3>
<p>Container images include the following attestations for transparency and
traceability:</p>
<ul>
<li><strong><a href="https://docs.docker.com/build/metadata/attestations/sbom/">Software Bill of Materials
  (SBOM)</a>:</strong> A
  comprehensive list of software artifacts included in the image or used during
  its build process, formatted using the
  <a href="https://github.com/in-toto/attestation/blob/main/spec/predicates/spdx.md">in-toto SPDX predicate standard</a>.</li>
<li><strong><a href="https://docs.docker.com/build/metadata/attestations/slsa-provenance/">Provenance</a>:</strong>
  Metadata detailing how the image was built, following the <a href="https://slsa.dev">SLSA Provenance</a>
  framework.</li>
</ul>
<p>You can retrieve the SBOM for a specific image and platform using the following
command:</p>
<pre><code class="language-shell">docker buildx imagetools inspect &lt;IMAGE&gt; \
  --format '{{ json (index .SBOM &quot;&lt;PLATFORM&gt;&quot;).SPDX }}'
</code></pre>
<p>This command outputs the SBOM in JSON format, providing a detailed view of the
software components and build dependencies.</p>
<p>For the provenance, use:</p>
<pre><code class="language-shell">docker buildx imagetools inspect &lt;IMAGE&gt; \
  --format '{{ json (index .Provenance &quot;&lt;PLATFORM&gt;&quot;).SLSA }}'
</code></pre>
<h3 id="guidelines-and-frameworks-for-container-security">Guidelines and Frameworks for Container Security</h3>
<p>The following guidelines and frameworks have been considered for ensuring
container-level security:</p>
<ul>
<li><strong><a href="https://dl.dod.cyber.mil/wp-content/uploads/devsecops/pdf/DevSecOps_Enterprise_Container_Image_Creation_and_Deployment_Guide_2.6-Public-Release.pdf">"Container Image Creation and Deployment Guide"</a>:</strong>
  Developed by the Defense Information Systems Agency (DISA) of the United States
  Department of Defense (DoD).</li>
<li><strong><a href="https://www.cisecurity.org/benchmark/docker/">"CIS Benchmark for Docker"</a>:</strong>
  Developed by the Center for Internet Security (CIS).</li>
</ul>
<div class="admonition seealso">
<p class="admonition-title">About Container-Level Security</p>
<p>For more information on the approach that EDB has taken regarding security
at the container level in CloudNativePG, please refer to the blog article
<a href="https://www.enterprisedb.com/blog/security-and-containers-cloud-native-postgresql">"Security and Containers in CloudNativePG"</a>.</p>
</div>
<h2 id="cluster">Cluster</h2>
<p>Security at the cluster level takes into account all Kubernetes components that
form both the control plane and the nodes, as well as the applications that run in
the cluster (PostgreSQL included).</p>
<h3 id="role-based-access-control-rbac">Role Based Access Control (RBAC)</h3>
<p>The operator interacts with the Kubernetes API server using a dedicated service
account named <code>cnpg-manager</code>. This service account is typically installed in
the operator namespace, commonly <code>cnpg-system</code>. However, the namespace may vary
based on the deployment method (see the subsection below).</p>
<p>In the same namespace, there is a binding between the <code>cnpg-manager</code> service
account and a role. The specific name and type of this role (either <code>Role</code> or
<code>ClusterRole</code>) also depend on the deployment method. This role defines the
necessary permissions required by the operator to function correctly. To learn
more about these roles, you can use the <code>kubectl describe clusterrole</code> or
<code>kubectl describe role</code> commands, depending on the deployment method.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The above permissions are exclusively reserved for the operator's service
account to interact with the Kubernetes API server.  They are not directly
accessible by the users of the operator that interact only with <code>Cluster</code>,
<code>Pooler</code>, <code>Backup</code>, <code>ScheduledBackup</code>, <code>Database</code>, <code>Publication</code>,
<code>Subscription</code>, <code>ImageCatalog</code> and <code>ClusterImageCatalog</code> resources.</p>
</div>
<p>Below we provide some examples and, most importantly, the reasons why
CloudNativePG requires full or partial management of standard Kubernetes
namespaced or non-namespaced resources.</p>
<dl>
<dt><code>configmaps</code></dt>
<dd>The operator needs to create and manage default config maps for
  the Prometheus exporter monitoring metrics.</dd>
<dt><code>deployments</code></dt>
<dd>The operator needs to manage a PgBouncer connection pooler
  using a standard Kubernetes <code>Deployment</code> resource.</dd>
<dt><code>jobs</code></dt>
<dd>The operator needs to handle jobs to manage different <code>Cluster</code>'s phases.</dd>
<dt><code>persistentvolumeclaims</code></dt>
<dd>The volume where the <code>PGDATA</code> resides is the
  central element of a PostgreSQL <code>Cluster</code> resource; the operator needs
  to interact with the selected storage class to dynamically provision
  the requested volumes, based on the defined scheduling policies.</dd>
<dt><code>pods</code></dt>
<dd>The operator needs to manage <code>Cluster</code>'s instances.</dd>
<dt><code>secrets</code></dt>
<dd>Unless you provide certificates and passwords to your <code>Cluster</code>
  objects, the operator adopts the "convention over configuration" paradigm by
  self-provisioning random generated passwords and TLS certificates, and by
  storing them in secrets.</dd>
<dt><code>serviceaccounts</code></dt>
<dd>The operator needs to create a service account that
  enables the instance manager (which is the <em>PID 1</em> process of the container
  that controls the PostgreSQL server) to safely communicate with the
  Kubernetes API server to coordinate actions and continuously provide
  a reliable status of the <code>Cluster</code>.</dd>
<dt><code>services</code></dt>
<dd>The operator needs to control network access to the PostgreSQL cluster
  (or the connection pooler) from applications, and properly manage
  failover/switchover operations in an automated way (by assigning, for example,
  the correct end-point of a service to the proper primary PostgreSQL instance).</dd>
<dt><code>validatingwebhookconfigurations</code> and <code>mutatingwebhookconfigurations</code></dt>
<dd>The operator injects its self-signed webhook CA into both webhook
  configurations, which are needed to validate and mutate all the resources it
  manages. For more details, please see the
  <a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/">Kubernetes documentation</a>.</dd>
<dt><code>volumesnapshots</code></dt>
<dd>The operator needs to generate <code>VolumeSnapshots</code> objects in order to take
  backups of a PostgreSQL server. VolumeSnapshots are read too in order to
  validate them before starting the restore process.</dd>
<dt><code>nodes</code></dt>
<dd>The operator needs to get the labels for Affinity and AntiAffinity so it can
  decide in which nodes a pod can be scheduled. This is useful, for example, to
  prevent the replicas from being scheduled in the same node - especially
  important if nodes are in different availability zones. This
  permission is also used to determine whether a node is scheduled, preventing
  the creation of pods on unscheduled nodes, or triggering a switchover if
  the primary lives in an unscheduled node.</dd>
</dl>
<h4 id="deployments-and-clusterrole-resources">Deployments and <code>ClusterRole</code> Resources</h4>
<p>As mentioned above, each deployment method may have variations in the namespace
location of the service account, as well as the names and types of role
bindings and respective roles.</p>
<h5 id="via-kubernetes-manifest">Via Kubernetes Manifest</h5>
<p>When installing CloudNativePG using the Kubernetes manifest, permissions are
set to <code>ClusterRoleBinding</code> by default. You can inspect the permissions
required by the operator by running:</p>
<pre><code class="language-sh">kubectl describe clusterrole cnpg-manager
</code></pre>
<h5 id="via-olm">Via OLM</h5>
<p>From a security perspective, the Operator Lifecycle Manager (OLM) provides a
more flexible deployment method. It allows you to configure the operator to
watch either all namespaces or specific namespaces, enabling more granular
permission management.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
</div>
<p>OLM allows you to deploy the operator in its own namespace and configure it
   to watch specific namespaces used for CloudNativePG clusters. This setup helps
   to contain permissions and restrict access more effectively.</p>
<h4 id="why-are-clusterrole-permissions-needed">Why Are ClusterRole Permissions Needed?</h4>
<p>The operator currently requires <code>ClusterRole</code> permissions to read <code>nodes</code> and
<code>ClusterImageCatalog</code> objects. All other permissions can be namespace-scoped (i.e., <code>Role</code>) or
cluster-wide (i.e., <code>ClusterRole</code>).</p>
<p>Even with these permissions, if someone gains access to the <code>ServiceAccount</code>,
they will only have <code>get</code>, <code>list</code>, and <code>watch</code> permissions, which are limited
to viewing resources. However, if an unauthorized user gains access to the
<code>ServiceAccount</code>, it indicates a more significant security issue.</p>
<p>Therefore, it's crucial to prevent users from accessing the operator's
<code>ServiceAccount</code> and any other <code>ServiceAccount</code> with elevated permissions.</p>
<h3 id="calls-to-the-api-server-made-by-the-instance-manager">Calls to the API server made by the instance manager</h3>
<p>The instance manager, which is the entry point of the operand container, needs
to make some calls to the Kubernetes API server to ensure that the status of
some resources is correctly updated and to access the config maps and secrets
that are associated with that Postgres cluster. Such calls are performed through
a dedicated <code>ServiceAccount</code> created by the operator that shares the same
PostgreSQL <code>Cluster</code> resource name.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The operand can only access a specific and limited subset of resources
through the API server. A service account is the
<a href="https://kubernetes.io/docs/tasks/run-application/access-api-from-pod/">recommended way to access the API server from within a Pod</a>.</p>
</div>
<p>For transparency, the permissions associated with the service account are defined in the
<a href="https://github.com/cloudnative-pg/cloudnative-pg/blob/main/pkg/specs/roles.go">roles.go</a>
file. For example, to retrieve the permissions of a generic <code>mypg</code> cluster in the
<code>myns</code> namespace, you can type the following command:</p>
<pre><code class="language-bash">kubectl get role -n myns mypg -o yaml
</code></pre>
<p>Then verify that the role is bound to the service account:</p>
<pre><code class="language-bash">kubectl get rolebinding -n myns mypg -o yaml
</code></pre>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Remember that <strong>roles are limited to a given namespace</strong>.</p>
</div>
<p>Below we provide a quick summary of the permissions associated with the service
account for generic Kubernetes resources.</p>
<dl>
<dt><code>configmaps</code></dt>
<dd>The instance manager can only read config maps that are related to the same
  cluster, such as custom monitoring queries</dd>
<dt><code>secrets</code></dt>
<dd>The instance manager can only read secrets that are related to the same
  cluster, namely: streaming replication user, application user, super user,
  LDAP authentication user, client CA, server CA, server certificate, backup
  credentials, custom monitoring queries</dd>
<dt><code>events</code></dt>
<dd>The instance manager can create an event for the cluster, informing the
  API server about a particular aspect of the PostgreSQL instance lifecycle</dd>
</dl>
<p>Here instead, we provide the same summary for resources specific to
CloudNativePG.</p>
<dl>
<dt><code>clusters</code></dt>
<dd>The instance manager requires read-only permissions, namely <code>get</code>, <code>list</code> and
  <code>watch</code>, just for its own <code>Cluster</code> resource</dd>
<dt><code>clusters/status</code></dt>
<dd>The instance manager requires to <code>update</code> and <code>patch</code> the status of just its
  own <code>Cluster</code> resource</dd>
<dt><code>backups</code></dt>
<dd>The instance manager requires <code>get</code> and <code>list</code> permissions to read any
  <code>Backup</code> resource in the namespace. Additionally, it requires the <code>delete</code>
  permission to clean up the Kubernetes cluster by removing the <code>Backup</code> objects
  that do not have a counterpart in the object store - typically because of
  retention policies</dd>
<dt><code>backups/status</code></dt>
<dd>The instance manager requires to <code>update</code> and <code>patch</code> the status of any
  <code>Backup</code> resource in the namespace</dd>
</dl>
<h3 id="pod-and-container-security-contexts">Pod and Container Security Contexts</h3>
<p>A <a href="https://kubernetes.io/docs/tasks/configure-pod-container/security-context/">Security Context</a>
defines privilege and access control settings for a pod or container.</p>
<p>CloudNativePG does not require <em>privileged</em> mode for container execution.
The PostgreSQL containers run as the <code>postgres</code> system user. No component
whatsoever requires running as <code>root</code>.</p>
<p>Likewise, Volume access does not require <em>privileged</em> mode nor <code>root</code>
privileges. Proper permissions must be assigned by the Kubernetes platform
and/or administrators. The PostgreSQL containers run with a read-only root
filesystem (i.e. no writable layer).</p>
<p>The operator manages the setting of security contexts for all pods and 
containers of a PostgreSQL cluster. The <a href="https://kubernetes.io/docs/tutorials/security/seccomp/">Seccomp Profile</a> 
to be used for the PostgreSQL containers can be configured with the 
<code>spec.seccompProfile</code> section of the <code>Cluster</code> resource. If this section is left
blank, the containers will use a seccompProfile <code>Type</code> of <code>RuntimeDefault</code>, that
is, the container runtime default.</p>
<p>The security context of PostgreSQL containers using the default <code>seccompProfile</code>
will look like this:</p>
<pre><code>securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
    - ALL
  privileged: false
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  seccompProfile:
    type: RuntimeDefault
</code></pre>
<h4 id="customizing-security-contexts">Customizing Security Contexts</h4>
<p>CloudNativePG provides fine-grained control over security contexts for both
pods and containers through the <code>spec.podSecurityContext</code> and
<code>spec.securityContext</code> fields respectively.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Changing security contexts can significantly affect the security posture
of your PostgreSQL clusters and may prevent pods from starting or
operating correctly. Before making changes, review which fields you will
override and how they merge with the operator defaults, test changes
in a non-production environment, and apply the minimal, well-documented
modifications necessary.</p>
</div>
<p><strong>Pod Security Context</strong> (<code>spec.podSecurityContext</code>):
This allows you to override the default <code>PodSecurityContext</code> applied to all
PostgreSQL cluster pods. When specified, it will merge with the operator's
default settings, with your values taking precedence for explicitly set fields.</p>
<p>Example:</p>
<pre><code class="language-yaml">apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: cluster-example
spec:
  instances: 3
  podSecurityContext:
    runAsUser: 26
    runAsGroup: 26
    fsGroup: 26
    supplementalGroups: [2000, 3000]
    fsGroupChangePolicy: &quot;OnRootMismatch&quot;
</code></pre>
<p><strong>Container Security Context</strong> (<code>spec.securityContext</code>):
This allows you to override the default <code>SecurityContext</code> applied to all
containers within the PostgreSQL cluster pods. Like <code>podSecurityContext</code>, it
merges with the operator's defaults.</p>
<p>Example:</p>
<pre><code class="language-yaml">apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: cluster-example
spec:
  instances: 3
  securityContext:
    allowPrivilegeEscalation: false
    # Note: capabilities are not merged with operator defaults.
    # If specified, they fully replace any defaults.
    capabilities:
      drop:
      - ALL
      add:
      - NET_BIND_SERVICE
    readOnlyRootFilesystem: true
    runAsNonRoot: true
</code></pre>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>For any fields you don't explicitly set, the operator will apply its
secure defaults. This ensures that even partial configurations maintain
security best practices.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>These fields are particularly useful when working with the
<a href="https://kubernetes.io/docs/concepts/security/pod-security-standards/">Pod Security Standards</a>
<code>restricted</code> profile, which has strict requirements for pod and container
security contexts.</p>
</div>
<h4 id="security-context-constraints">Security Context Constraints</h4>
<p>When running in an environment that is utilizing
<a href="https://docs.openshift.com/container-platform/4.17/authentication/managing-security-context-constraints.html">Security Context Constraints (SCC)</a>
the operator does not explicitly set the security context of the PostgreSQL
cluster pods, but rather allows the pods to inherit the restricted Security
Context Constraints that are already defined.</p>
<h3 id="restricting-pod-access-using-apparmor">Restricting Pod access using AppArmor</h3>
<p>You can assign an
<a href="https://kubernetes.io/docs/tutorials/security/apparmor/">AppArmor</a> profile to
the <code>postgres</code>, <code>initdb</code>, <code>join</code>, <code>full-recovery</code> and <code>bootstrap-controller</code> containers inside every <code>Cluster</code> pod through the
<code>container.apparmor.security.beta.kubernetes.io</code> annotation.</p>
<div class="admonition seealso">
<p class="admonition-title">Example of cluster annotations</p>
</div>
<pre><code>    kind: Cluster
    metadata:
        name: cluster-apparmor
        annotations:
            container.apparmor.security.beta.kubernetes.io/postgres: runtime/default
            container.apparmor.security.beta.kubernetes.io/initdb: runtime/default
            container.apparmor.security.beta.kubernetes.io/join: runtime/default
</code></pre>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Using this kind of annotations can result in your cluster to stop working.
If this is the case, the annotation can be safely removed from the <code>Cluster</code>.</p>
</div>
<p>The AppArmor configuration must be at Kubernetes node level, meaning that the
underlying operating system must have this option enable and properly
configured.</p>
<p>In case this is not the situation, and the annotations were added at the
<code>Cluster</code> creation time, pods will not be created. On the other hand, if you
add the annotations after the <code>Cluster</code> was created the pods in the cluster will
be unable to start and you will get an error like this:</p>
<pre><code>metadata.annotations[container.apparmor.security.beta.kubernetes.io/postgres]: Forbidden: may not add AppArmor annotations]
</code></pre>
<p>In such cases, please refer to your Kubernetes administrators and ask for the
proper AppArmor profile to use.</p>
<h3 id="network-policies">Network Policies</h3>
<p>The pods created by the <code>Cluster</code> resource can be controlled by Kubernetes
<a href="https://kubernetes.io/docs/concepts/services-networking/network-policies/">network policies</a>
to enable/disable inbound and outbound network access at IP and TCP level.
You can find more information in the <a href="../networking/">networking document</a>.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The operator needs to communicate to each instance on TCP port 8000
to get information about the status of the PostgreSQL server. Please
make sure you keep this in mind in case you add any network policy,
and refer to the "Exposed Ports" section below for a list of ports used by
CloudNativePG for finer control.</p>
</div>
<p>Network policies are beyond the scope of this document.
Please refer to the <a href="https://kubernetes.io/docs/concepts/services-networking/network-policies/">"Network policies"</a>
section of the Kubernetes documentation for further information.</p>
<h4 id="exposed-ports">Exposed Ports</h4>
<p>CloudNativePG exposes ports at operator, instance manager and operand
levels, as listed in the table below:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">System</th>
<th style="text-align: left;">Port number</th>
<th style="text-align: left;">Exposing</th>
<th style="text-align: left;">Name</th>
<th style="text-align: left;">TLS</th>
<th style="text-align: left;">Authentication</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">operator</td>
<td style="text-align: left;">9443</td>
<td style="text-align: left;">webhook server</td>
<td style="text-align: left;"><code>webhook-server</code></td>
<td style="text-align: left;">Yes</td>
<td style="text-align: left;">Yes</td>
</tr>
<tr>
<td style="text-align: left;">operator</td>
<td style="text-align: left;">8080</td>
<td style="text-align: left;">metrics</td>
<td style="text-align: left;"><code>metrics</code></td>
<td style="text-align: left;">No</td>
<td style="text-align: left;">No</td>
</tr>
<tr>
<td style="text-align: left;">instance manager</td>
<td style="text-align: left;">9187</td>
<td style="text-align: left;">metrics</td>
<td style="text-align: left;"><code>metrics</code></td>
<td style="text-align: left;">Optional</td>
<td style="text-align: left;">No</td>
</tr>
<tr>
<td style="text-align: left;">instance manager</td>
<td style="text-align: left;">8000</td>
<td style="text-align: left;">status</td>
<td style="text-align: left;"><code>status</code></td>
<td style="text-align: left;">Yes</td>
<td style="text-align: left;">No</td>
</tr>
<tr>
<td style="text-align: left;">operand</td>
<td style="text-align: left;">5432</td>
<td style="text-align: left;">PostgreSQL instance</td>
<td style="text-align: left;"><code>postgresql</code></td>
<td style="text-align: left;">Optional</td>
<td style="text-align: left;">Yes</td>
</tr>
</tbody>
</table>
<h3 id="postgresql">PostgreSQL</h3>
<p>The current implementation of CloudNativePG automatically creates
passwords and <code>.pgpass</code> files for the database owner and, only
if requested by setting <code>enableSuperuserAccess</code> to <code>true</code>, for the
<code>postgres</code> superuser.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><code>enableSuperuserAccess</code> is set to <code>false</code> by default to improve the
security-by-default posture of the operator, fostering a microservice approach
where changes to PostgreSQL are performed in a declarative way through the
<code>spec</code> of the <code>Cluster</code> resource, while providing developers with full powers
inside the database through the database owner user.</p>
</div>
<p>As far as password encryption is concerned, CloudNativePG follows
the default behavior of PostgreSQL: starting from PostgreSQL 14,
<code>password_encryption</code> is by default set to <code>scram-sha-256</code>, while on earlier
versions it is set to <code>md5</code>.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Please refer to the <a href="https://www.postgresql.org/docs/current/auth-password.html">"Password authentication"</a>
section in the PostgreSQL documentation for details.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The operator supports toggling the <code>enableSuperuserAccess</code> option. When you
disable it on a running cluster, the operator will ignore the content of the secret,
remove it (if previously generated by the operator) and set the password of the
<code>postgres</code> user to <code>NULL</code> (de facto disabling remote access through password authentication).</p>
</div>
<p>See the <a href="../applications/#secrets">"Secrets" section in the "Connecting from an application" page</a> for more information.</p>
<p>You can use those files to configure application access to the database.</p>
<p>By default, every replica is automatically configured to connect in <strong>physical
async streaming replication</strong> with the current primary instance, with a special
user called <code>streaming_replica</code>. The connection between nodes is <strong>encrypted</strong>
and authentication is via <strong>TLS client certificates</strong> (please refer to the
<a href="../ssl_connections/" title="Client TLS/SSL Connections">"Client TLS/SSL Connections"</a> page
for details). By default, the operator requires TLS v1.3 connections.</p>
<p>Currently, the operator allows administrators to add <code>pg_hba.conf</code> lines directly in the manifest
as part of the <code>pg_hba</code> section of the <code>postgresql</code> configuration. The lines defined in the
manifest are added to a default <code>pg_hba.conf</code>.</p>
<p>For further detail on how <code>pg_hba.conf</code> is managed by the operator, see the
<a href="../postgresql_conf/#the-pg_hba-section">"PostgreSQL Configuration" page</a> of the documentation.</p>
<p>The administrator can also customize the content of the <code>pg_ident.conf</code> file that by default
only maps the local postgres user to the postgres user in the database.</p>
<p>For further detail on how <code>pg_ident.conf</code> is managed by the operator, see the
<a href="../postgresql_conf/#the-pg_ident-section">"PostgreSQL Configuration" page</a> of the documentation.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Examples assume that the Kubernetes cluster runs in a private and secure network.</p>
</div>
<h3 id="storage">Storage</h3>
<p>CloudNativePG delegates encryption at rest to the underlying storage class. For
data protection in production environments, we highly recommend that you choose
a storage class that supports encryption at rest.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../database_import/" class="btn btn-neutral float-left" title="Importing Postgres databases"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../instance_manager/" class="btn btn-neutral float-right" title="Postgres instance manager">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>Copyright © CloudNativePG a Series of LF Projects, LLC</p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../database_import/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../instance_manager/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
