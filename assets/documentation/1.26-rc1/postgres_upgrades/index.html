<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="The CloudNativePG Contributors" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>PostgreSQL Upgrades - CloudNativePG v1.26-rc1</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/override.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "PostgreSQL Upgrades";
        var mkdocs_page_input_path = "postgres_upgrades.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> CloudNativePG v1.26-rc1
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">CloudNativePG</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../before_you_start/">Before You Start</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../use_cases/">Use cases</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../architecture/">Architecture</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../installation_upgrade/">Installation and upgrades</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../quickstart/">Quickstart</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../image_catalog/">Image Catalog</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../bootstrap/">Bootstrap</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../database_import/">Importing Postgres databases</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../security/">Security</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../instance_manager/">Postgres instance manager</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../scheduling/">Scheduling</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../resource_management/">Resource management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../failure_modes/">Failure Modes</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../rolling_update/">Rolling Updates</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../replication/">Replication</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../logical_replication/">Logical Replication</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../backup/">Backup</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../backup_barmanobjectstore/">Backup on object stores</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../wal_archiving/">WAL archiving</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../backup_volumesnapshot/">Backup on volume snapshots</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../recovery/">Recovery</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../service_management/">Service Management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../postgresql_conf/">PostgreSQL Configuration</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../declarative_role_management/">PostgreSQL Role Management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../declarative_database_management/">PostgreSQL Database Management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../tablespaces/">Tablespaces</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../operator_conf/">Operator configuration</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../cluster_conf/">Instance pod configuration</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../storage/">Storage</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../labels_annotations/">Labels and annotations</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../monitoring/">Monitoring</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../logging/">Logging</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../certificates/">Certificates</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../ssl_connections/">Client TLS/SSL connections</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../applications/">Connecting from an application</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../connection_pooling/">Connection pooling</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../replica_cluster/">Replica clusters</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../kubernetes_upgrade/">Kubernetes Upgrade and Maintenance</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">PostgreSQL Upgrades</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#minor-version-upgrades">Minor Version Upgrades</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#upgrading-a-minor-version-in-cloudnativepg">Upgrading a Minor Version in CloudNativePG</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#major-version-upgrades">Major Version Upgrades</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#offline-in-place-major-upgrades">Offline In-Place Major Upgrades</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#upgrade-process">Upgrade Process</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#post-upgrade-actions">Post-Upgrade Actions</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#example-performing-a-major-upgrade">Example: Performing a Major Upgrade</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#upgrade-process_1">Upgrade Process</a>
    </li>
        </ul>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../kubectl-plugin/">Kubectl Plugin</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../failover/">Automated failover</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../troubleshooting/">Troubleshooting</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../fencing/">Fencing</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../declarative_hibernation/">Declarative hibernation</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../postgis/">PostGIS</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../e2e/">End-to-End Tests</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../container_images/">Container Image Requirements</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../operator_capability_levels/">Operator capability levels</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../controller/">Custom Pod Controller</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../samples/">Examples</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../networking/">Networking</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../benchmarking/">Benchmarking</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../faq/">Frequently Asked Questions (FAQ)</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../cloudnative-pg.v1/">API Reference</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../supported_releases/">Supported releases</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../preview_version/">Preview Versions</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../release_notes/">Release notes</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Appendixes</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../appendixes/object_stores/">Appendix A - Common object stores for backups</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">CloudNativePG v1.26-rc1</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">PostgreSQL Upgrades</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="postgresql-upgrades">PostgreSQL Upgrades</h1>
<!-- SPDX-License-Identifier: CC-BY-4.0 -->

<p>PostgreSQL upgrades fall into two categories:</p>
<ul>
<li><a href="#minor-version-upgrades">Minor version upgrades</a> (e.g., from 17.0 to 17.1)</li>
<li><a href="#major-version-upgrades">Major version upgrades</a> (e.g., from 16.x to 17.0)</li>
</ul>
<h2 id="minor-version-upgrades">Minor Version Upgrades</h2>
<p>PostgreSQL version numbers follow a <code>major.minor</code> format. For instance, in
version 17.1:</p>
<ul>
<li><code>17</code> is the major version</li>
<li><code>1</code> is the minor version</li>
</ul>
<p>Minor releases are fully compatible with earlier and later minor releases of
the same major version. They include bug fixes and security updates but do not
introduce changes to the internal storage format.
For example, PostgreSQL 17.1 is compatible with 17.0 and 17.4.</p>
<h3 id="upgrading-a-minor-version-in-cloudnativepg">Upgrading a Minor Version in CloudNativePG</h3>
<p>To upgrade to a newer minor version, simply update the PostgreSQL container
image reference in your cluster definition, either directly or via image catalogs.
CloudNativePG will trigger a <a href="../rolling_update/">rolling update of the cluster</a>,
replacing each instance one by one, starting with the replicas. Once all
replicas have been updated, it will perform either a switchover or a restart of
the primary to complete the process.</p>
<h2 id="major-version-upgrades">Major Version Upgrades</h2>
<p>Major PostgreSQL releases introduce changes to the internal data storage
format, requiring a more structured upgrade process.</p>
<p>CloudNativePG supports three methods for performing major upgrades:</p>
<ol>
<li><a href="../database_import/">Logical dump/restore</a> – Blue/green deployment, offline.</li>
<li><a href="../logical_replication/#example-of-live-migration-and-major-postgres-upgrade-with-logical-replication">Native logical replication</a> – Blue/green deployment, online.</li>
<li>Physical with <code>pg_upgrade</code> – In-place upgrade, offline (covered in the
   <a href="#offline-in-place-major-upgrades">"Offline In-Place Major Upgrades" section</a> below).</li>
</ol>
<p>Each method has trade-offs in terms of downtime, complexity, and data volume
handling. The best approach depends on your upgrade strategy and operational
constraints.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>We strongly recommend testing all methods in a controlled environment
before proceeding with a production upgrade.</p>
</div>
<h2 id="offline-in-place-major-upgrades">Offline In-Place Major Upgrades</h2>
<p>CloudNativePG performs an <strong>offline in-place major upgrade</strong> when a new operand
container image with a higher PostgreSQL major version is declaratively
requested for a cluster.</p>
<p>You can trigger the upgrade in one of two ways:</p>
<ul>
<li>By updating the major version in the image tag via the <code>.spec.imageName</code>
  option.</li>
<li>Using an <a href="../image_catalog/">image catalog</a> to manage version changes.</li>
</ul>
<p>For details on supported image tags, see
<a href="../container_images/#image-tag-requirements">"Image Tag Requirements"</a>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>CloudNativePG is not responsible for PostgreSQL extensions. You must ensure
that extensions in the source PostgreSQL image are compatible with those in the
target image and that upgrade paths are supported. Thoroughly test the upgrade
process in advance to avoid unexpected issues.
The <a href="../declarative_database_management/#managing-extensions-in-a-database">extensions management feature</a>
can help manage extension upgrades declaratively.</p>
</div>
<h3 id="upgrade-process">Upgrade Process</h3>
<ol>
<li>Shuts down all cluster pods to ensure data consistency.</li>
<li>Records the previous PostgreSQL version in the cluster’s status under
   <code>.status.majorVersionUpgradeFromImage</code>.</li>
<li>Initiates a new upgrade job, which:</li>
<li>Verifies that the binaries in the image and the data files align with a
     major upgrade request.</li>
<li>Creates new directories for <code>PGDATA</code>, and where applicable, WAL files and
     tablespaces.</li>
<li>Performs the upgrade using <code>pg_upgrade</code> with the <code>--link</code> option.</li>
<li>Upon successful completion, replaces the original directories with their
     upgraded counterparts.</li>
</ol>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>During the upgrade process, the entire PostgreSQL cluster, including
replicas, is unavailable to applications. Ensure that your system can
tolerate this downtime before proceeding.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Performing an in-place upgrade is an exceptional operation that carries inherent
risks. It is strongly recommended to take a full backup of the cluster before
initiating the upgrade process.</p>
</div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>For detailed guidance on <code>pg_upgrade</code>, refer to the official
<a href="https://www.postgresql.org/docs/current/pgupgrade.html">PostgreSQL documentation</a>.</p>
</div>
<h3 id="post-upgrade-actions">Post-Upgrade Actions</h3>
<p>If the upgrade is successful, CloudNativePG:</p>
<ul>
<li>Destroys the PVCs of replicas (if available).</li>
<li>Scales up replicas as required.</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Re-cloning replicas can be time-consuming, especially for very large
databases. Plan accordingly to accommodate potential delays. After completing
the upgrade, it is strongly recommended to take a full backup. Existing backup
data (namely base backups and WAL files) is only available for the previous
minor PostgreSQL release.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><code>pg_upgrade</code> doesn't transfer optimizer statistics. After the upgrade, you
may want to run <code>ANALYZE</code> on your databases to update them.</p>
</div>
<p>If the upgrade fails, you must manually revert the major version change in the
cluster's configuration and delete the upgrade job, as CloudNativePG cannot
automatically decide the rollback.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>This process <strong>protects your existing database from data loss</strong>, as no data
is modified during the upgrade. If the upgrade fails, a rollback is
usually possible, without having to perform a full recovery from a backup.
Ensure you monitor the process closely and take corrective action if needed.</p>
</div>
<h3 id="example-performing-a-major-upgrade">Example: Performing a Major Upgrade</h3>
<p>Consider the following PostgreSQL cluster running version 16:</p>
<pre><code class="language-yaml">apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: cluster-example
spec:
  imageName: ghcr.io/cloudnative-pg/postgresql:16-minimal-bookworm
  instances: 3
  storage:
    size: 1Gi
</code></pre>
<p>You can check the current PostgreSQL version using the following command:</p>
<pre><code class="language-sh">kubectl cnpg psql cluster-example -- -qAt -c 'SELECT version()'
</code></pre>
<p>This will return output similar to:</p>
<pre><code class="language-console">PostgreSQL 16.x ...
</code></pre>
<p>To upgrade the cluster to version 17, update the <code>imageName</code> field by changing
the major version tag from <code>16</code> to <code>17</code>:</p>
<pre><code class="language-yaml">apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: cluster-example
spec:
  imageName: ghcr.io/cloudnative-pg/postgresql:17-minimal-bookworm
  instances: 3
  storage:
    size: 1Gi
</code></pre>
<h3 id="upgrade-process_1">Upgrade Process</h3>
<ol>
<li>Cluster shutdown – All cluster pods are terminated to ensure a consistent
   upgrade.</li>
<li>Upgrade job execution – A new job is created with the name of the primary
   pod, appended with the suffix <code>-major-upgrade</code>. This job runs <code>pg_upgrade</code>
   on the primary’s persistent volume group.</li>
<li>Post-upgrade steps:</li>
<li>The PVC groups of the replicas (<code>cluster-example-2</code> and
     <code>cluster-example-3</code>) are removed.</li>
<li>The primary pod is restarted.</li>
<li>Two new replicas (<code>cluster-example-4</code> and <code>cluster-example-5</code>) are
     re-cloned from the upgraded primary.</li>
</ol>
<p>Once the upgrade is complete, you can verify the new major version by running
the same command:</p>
<pre><code class="language-sh">kubectl cnpg psql cluster-example -- -qAt -c 'SELECT version()'
</code></pre>
<p>This should now return output similar to:</p>
<pre><code class="language-console">PostgreSQL 17.x ...
</code></pre>
<p>You can now update the statistics by running <code>ANALYZE</code> on the <code>app</code> database:</p>
<pre><code class="language-sh">kubectl cnpg psql cluster-example -- app -c 'ANALYZE'
</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../kubernetes_upgrade/" class="btn btn-neutral float-left" title="Kubernetes Upgrade and Maintenance"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../kubectl-plugin/" class="btn btn-neutral float-right" title="Kubectl Plugin">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>Copyright © CloudNativePG a Series of LF Projects, LLC</p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../kubernetes_upgrade/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../kubectl-plugin/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
