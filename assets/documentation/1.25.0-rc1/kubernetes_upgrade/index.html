<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="The CloudNativePG Contributors" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Kubernetes Upgrade and Maintenance - CloudNativePG v1.25.0-rc1</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/override.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Kubernetes Upgrade and Maintenance";
        var mkdocs_page_input_path = "kubernetes_upgrade.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> CloudNativePG v1.25.0-rc1
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">CloudNativePG</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../before_you_start/">Before You Start</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../use_cases/">Use cases</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../architecture/">Architecture</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../installation_upgrade/">Installation and upgrades</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../quickstart/">Quickstart</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../image_catalog/">Image Catalog</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../bootstrap/">Bootstrap</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../database_import/">Importing Postgres databases</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../security/">Security</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../instance_manager/">Postgres instance manager</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../scheduling/">Scheduling</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../resource_management/">Resource management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../failure_modes/">Failure Modes</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../rolling_update/">Rolling Updates</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../replication/">Replication</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../logical_replication/">Logical Replication</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../backup/">Backup</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../backup_barmanobjectstore/">Backup on object stores</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../wal_archiving/">WAL archiving</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../backup_volumesnapshot/">Backup on volume snapshots</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../recovery/">Recovery</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../service_management/">Service Management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../postgresql_conf/">PostgreSQL Configuration</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../declarative_role_management/">PostgreSQL Role Management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../declarative_database_management/">PostgreSQL Database Management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../tablespaces/">Tablespaces</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../operator_conf/">Operator configuration</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../cluster_conf/">Instance pod configuration</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../storage/">Storage</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../labels_annotations/">Labels and annotations</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../monitoring/">Monitoring</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../logging/">Logging</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../certificates/">Certificates</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../ssl_connections/">Client TLS/SSL connections</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../applications/">Connecting from an application</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../connection_pooling/">Connection pooling</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../replica_cluster/">Replica clusters</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">Kubernetes Upgrade and Maintenance</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#importance-of-regular-updates">Importance of Regular Updates</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#maintenance-operations-in-a-cluster">Maintenance Operations in a Cluster</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#temporary-postgresql-cluster-degradation">Temporary PostgreSQL Cluster Degradation</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#pod-disruption-budgets">Pod Disruption Budgets</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#postgresql-clusters-used-for-development-or-testing">PostgreSQL Clusters used for Development or Testing</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#node-maintenance-window">Node Maintenance Window</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#single-instance-clusters-with-reusepvc-set-to-false">Single instance clusters with reusePVC set to false</a>
    </li>
        </ul>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../kubectl-plugin/">Kubectl Plugin</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../failover/">Automated failover</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../troubleshooting/">Troubleshooting</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../fencing/">Fencing</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../declarative_hibernation/">Declarative hibernation</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../postgis/">PostGIS</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../e2e/">End-to-End Tests</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../container_images/">Container Image Requirements</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../operator_capability_levels/">Operator capability levels</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../controller/">Custom Pod Controller</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../samples/">Examples</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../networking/">Networking</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../benchmarking/">Benchmarking</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../faq/">Frequently Asked Questions (FAQ)</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../cloudnative-pg.v1/">API Reference</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../supported_releases/">Supported releases</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../preview_version/">Preview Versions</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../release_notes/">Release notes</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Appendixes</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../appendixes/object_stores/">Appendix A - Common object stores for backups</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">CloudNativePG v1.25.0-rc1</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Kubernetes Upgrade and Maintenance</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="kubernetes-upgrade-and-maintenance">Kubernetes Upgrade and Maintenance</h1>
<p>Maintaining an up-to-date Kubernetes cluster is crucial for ensuring optimal
performance and security, particularly for self-managed clusters, especially
those running on bare metal infrastructure. Regular updates help address
technical debt and mitigate business risks, despite the controlled downtimes
associated with temporarily removing a node from the cluster for maintenance
purposes. For further insights on embracing risk in operations, refer to the
<a href="https://landing.google.com/sre/sre-book/chapters/embracing-risk/">"Embracing Risk"</a>
chapter from the Site Reliability Engineering book.</p>
<h2 id="importance-of-regular-updates">Importance of Regular Updates</h2>
<p>Updating Kubernetes involves planning and executing maintenance tasks, such as
applying security updates to underlying Linux servers, replacing malfunctioning
hardware components, or upgrading the cluster to the latest Kubernetes version.
These activities are essential for maintaining a robust and secure
infrastructure.</p>
<h2 id="maintenance-operations-in-a-cluster">Maintenance Operations in a Cluster</h2>
<p>Typically, maintenance operations are carried out on one node at a time, following a <a href="https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/">structured process</a>:</p>
<ol>
<li>eviction of workloads (<code>drain</code>): workloads are gracefully moved away from
   the node to be updated, ensuring a smooth transition.</li>
<li>performing the operation: the actual maintenance operation, such as a
   system update or hardware replacement, is executed.</li>
<li>rejoining the node to the cluster (<code>uncordon</code>): the updated node is
   reintegrated into the cluster, ready to resume its responsibilities.</li>
</ol>
<p>This process requires either stopping workloads for the entire upgrade duration
or migrating them to other nodes in the cluster.</p>
<h2 id="temporary-postgresql-cluster-degradation">Temporary PostgreSQL Cluster Degradation</h2>
<p>While the standard approach ensures service reliability and leverages
Kubernetes' self-healing capabilities, there are scenarios where operating with
a temporarily degraded cluster may be acceptable. This is particularly relevant
for PostgreSQL clusters relying on <strong>node-local storage</strong>, where the storage is
local to the Kubernetes worker node running the PostgreSQL database. Node-local
storage, or simply <em>local storage</em>, is employed to enhance performance.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If your database files reside on shared storage accessible over the
network, the default self-healing behavior of the operator can efficiently
handle scenarios where volumes are reused by pods on different nodes after a
drain operation. In such cases, you can skip the remaining sections of this
document.</p>
</div>
<h2 id="pod-disruption-budgets">Pod Disruption Budgets</h2>
<p>By default, CloudNativePG safeguards Postgres cluster operations. If a node is
to be drained and contains a cluster's primary instance, a switchover happens
ahead of the drain. Once the instance in the node is downgraded to replica, the
draining can resume.
For single-instance clusters, a switchover is not possible, so CloudNativePG
will prevent draining the node where the instance is housed.
Additionally, in clusters with 3 or more instances, CloudNativePG guarantees that
only one replica at a time is gracefully shut down during a drain operation.</p>
<p>Each PostgreSQL <code>Cluster</code> is equipped with two associated <code>PodDisruptionBudget</code>
resources - you can easily confirm it with the <code>kubectl get pdb</code> command.</p>
<p>Our recommendation is to leave pod disruption budgets enabled for every
production Postgres cluster. This can be effortlessly managed by toggling the
<code>.spec.enablePDB</code> option, as detailed in the
<a href="../cloudnative-pg.v1/#postgresql-cnpg-io-v1-ClusterSpec">API reference</a>.</p>
<h2 id="postgresql-clusters-used-for-development-or-testing">PostgreSQL Clusters used for Development or Testing</h2>
<p>For PostgreSQL clusters used for development purposes, often consisting of
a single instance, it is essential to disable pod disruption budgets. Failure
to do so will prevent the node hosting that cluster from being drained.</p>
<p>The following example illustrates how to disable pod disruption budgets for a
1-instance development cluster:</p>
<pre><code class="language-yaml">apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: dev
spec:
  instances: 1
  enablePDB: false

  storage:
    size: 1Gi
</code></pre>
<p>This configuration ensures smoother maintenance procedures without restrictions
on draining the node during development activities.</p>
<h2 id="node-maintenance-window">Node Maintenance Window</h2>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>While CloudNativePG will continue supporting the node maintenance window,
it is currently recommended to transition to direct control of pod disruption
budgets, as explained in the previous section. This section is retained
mainly for backward compatibility.</p>
</div>
<p>Prior to release 1.23, CloudNativePG had just one declarative mechanism to manage
Kubernetes upgrades when dealing with local storage: you had to temporarily put
the cluster in <strong>maintenance mode</strong> through the <code>nodeMaintenanceWindow</code> option
to avoid standard self-healing procedures to kick in, while, for example,
enlarging the partition on the physical node or updating the node itself.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Limit the duration of the maintenance window to the shortest
amount of time possible. In this phase, some of the expected
behaviors of Kubernetes are either disabled or running with
some limitations, including self-healing, rolling updates,
and Pod disruption budget.</p>
</div>
<p>The <code>nodeMaintenanceWindow</code> option of the cluster has two further
settings:</p>
<p><code>inProgress</code>:
Boolean value that states if the maintenance window for the nodes
is currently in progress or not. By default, it is set to <code>off</code>.
During the maintenance window, the <code>reusePVC</code> option below is
evaluated by the operator.</p>
<p><code>reusePVC</code>:
Boolean value that defines if an existing PVC is reused or
not during the maintenance operation. By default, it is set to <code>on</code>.
When <strong>enabled</strong>, Kubernetes waits for the node to come up
again and then reuses the existing PVC; the <code>PodDisruptionBudget</code>
policy is temporarily removed.
When <strong>disabled</strong>, Kubernetes forces the recreation of the
Pod on a different node with a new PVC by relying on
PostgreSQL's physical streaming replication, then destroys
the old PVC together with the Pod. This scenario is generally
not recommended unless the database's size is small, and re-cloning
the new PostgreSQL instance takes shorter than waiting. This behavior
does <strong>not</strong> apply to clusters with only one instance and
reusePVC disabled: see section below.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When performing the <code>kubectl drain</code> command, you will need
to add the <code>--delete-emptydir-data</code> option.
Don't be afraid: it refers to another volume internally used
by the operator - not the PostgreSQL data directory.</p>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p><code>PodDisruptionBudget</code> management can be disabled by setting the
<code>.spec.enablePDB</code> field to <code>false</code>. In that case, the operator won't
create <code>PodDisruptionBudgets</code> and will delete them if they were
previously created.</p>
</div>
<h3 id="single-instance-clusters-with-reusepvc-set-to-false">Single instance clusters with <code>reusePVC</code> set to <code>false</code></h3>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>We recommend to always create clusters with more
than one instance in order to guarantee high availability.</p>
</div>
<p>Deleting the only PostgreSQL instance in a single instance cluster with
<code>reusePVC</code> set to <code>false</code> would imply all data being lost,
therefore we prevent users from draining nodes such instances might be running
on, even in maintenance mode.</p>
<p>However, in case maintenance is required for such a node you have two options:</p>
<ol>
<li>Enable <code>reusePVC</code>, accepting the downtime</li>
<li>Replicate the instance on a different node and switch over the primary</li>
</ol>
<p>As long as a database service downtime is acceptable for your environment,
draining the node is as simple as setting the <code>nodeMaintenanceWindow</code> to
<code>inProgress: true</code> and <code>reusePVC: true</code>. This will allow the instance to
be deleted and recreated as soon as the original PVC is available
(e.g. with node local storage, as soon as the node is back up).</p>
<p>Otherwise you will have to scale up the cluster, creating a new instance
on a different node and promoting the new instance to primary in order to
shut down the original one on the node undergoing maintenance. The only
downtime in this case will be the duration of the switchover.</p>
<p>A possible approach could be:</p>
<ol>
<li>Cordon the node on which the current instance is running.</li>
<li>Scale up the cluster to 2 instances, could take some time depending on the database size.</li>
<li>As soon as the new instance is running, the operator will automatically
   perform a switchover given that the current primary is running on a cordoned node.</li>
<li>Scale back down the cluster to a single instance, this will delete the old instance</li>
<li>The old primary's node can now be drained successfully, while leaving the new primary
   running on a new node.</li>
</ol>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../replica_cluster/" class="btn btn-neutral float-left" title="Replica clusters"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../kubectl-plugin/" class="btn btn-neutral float-right" title="Kubectl Plugin">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../replica_cluster/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../kubectl-plugin/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
