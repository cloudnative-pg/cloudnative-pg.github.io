<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="The CloudNativePG Contributors" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Image Volume Extensions - CloudNativePG v1.27</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/override.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Image Volume Extensions";
        var mkdocs_page_input_path = "imagevolume_extensions.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> CloudNativePG v1.27
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">CloudNativePG</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../before_you_start/">Before you start</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../use_cases/">Use cases</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../architecture/">Architecture</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../installation_upgrade/">Installation and upgrades</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../quickstart/">Quickstart</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../image_catalog/">Image Catalog</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../bootstrap/">Bootstrap</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../database_import/">Importing Postgres databases</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../security/">Security</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../instance_manager/">Postgres Instance Manager</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../scheduling/">Scheduling</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../resource_management/">Resource management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../failure_modes/">Failure Modes</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../rolling_update/">Rolling updates</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../replication/">Replication</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../logical_replication/">Logical Replication</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../backup/">Backup</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../wal_archiving/">WAL archiving</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../recovery/">Recovery</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../service_management/">Service management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../postgresql_conf/">PostgreSQL Configuration</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../declarative_role_management/">PostgreSQL Role management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../declarative_database_management/">PostgreSQL Database management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../tablespaces/">Tablespaces</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../operator_conf/">Operator configuration</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../cluster_conf/">Instance Pod configuration</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../storage/">Storage</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../labels_annotations/">Labels and Annotations</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../monitoring/">Monitoring</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../logging/">Logging</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../certificates/">Certificates</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../ssl_connections/">Client TLS/SSL connections</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../applications/">Connecting from an application</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../connection_pooling/">Connection Pooling</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../replica_cluster/">Replica clusters</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../kubernetes_upgrade/">Kubernetes upgrade and maintenance</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../postgres_upgrades/">PostgreSQL upgrades</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../kubectl-plugin/">Kubectl Plugin</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../failover/">Automated failover</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../troubleshooting/">Troubleshooting</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../fencing/">Fencing</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../declarative_hibernation/">Declarative hibernation</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../postgis/">PostGIS</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../e2e/">End-to-End Tests</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../container_images/">Container Image Requirements</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">Image Volume Extensions</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#benefits">Benefits</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#requirements">Requirements</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#how-it-works">How it works</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#how-to-add-a-new-extension">How to add a new extension</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#adding-a-new-extension-to-a-cluster-resource">Adding a new extension to a Cluster resource</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#adding-a-new-extension-to-a-database-resource">Adding a new extension to a Database resource</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#advanced-topics">Advanced Topics</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#setting-custom-paths">Setting Custom Paths</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#multi-extension-images">Multi-extension Images</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#including-system-libraries">Including System Libraries</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#image-specifications">Image Specifications</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#caveats">Caveats</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../cnpg_i/">CNPG-I</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../operator_capability_levels/">Operator capability levels</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../controller/">Custom Pod Controller</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../samples/">Examples</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../networking/">Networking</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../benchmarking/">Benchmarking</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../faq/">Frequently Asked Questions (FAQ)</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../cloudnative-pg.v1/">API Reference</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../supported_releases/">Supported releases</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../preview_version/">Preview Versions</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../release_notes/">Release notes</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">CNCF Projects Integrations</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../cncf-projects/external-secrets/">External Secrets</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cncf-projects/cilium/">Cilium</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Appendixes</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../appendixes/backup_volumesnapshot/">Appendix A - Backup on volume snapshots</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../appendixes/backup_barmanobjectstore/">Appendix B - Backup on object stores</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../appendixes/object_stores/">Appendix C - Common object stores for backups</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">CloudNativePG v1.27</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Image Volume Extensions</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="image-volume-extensions">Image Volume Extensions</h1>
<!-- SPDX-License-Identifier: CC-BY-4.0 -->

<p>CloudNativePG supports the <strong>dynamic loading of PostgreSQL extensions</strong> into a
<code>Cluster</code> at Pod startup using the <a href="https://kubernetes.io/docs/tasks/configure-pod-container/image-volumes/">Kubernetes <code>ImageVolume</code> feature</a>
and the <code>extension_control_path</code> GUC introduced in PostgreSQL 18, to which this
project contributed.</p>
<p>This feature allows you to mount a <a href="https://www.postgresql.org/docs/current/extend-extensions.html">PostgreSQL extension</a>,
packaged as an OCI-compliant container image, as a read-only and immutable
volume inside a running pod at a known filesystem path.</p>
<p>You can make the extension available either globally, using the
<a href="../postgresql_conf/#shared-preload-libraries"><code>shared_preload_libraries</code> option</a>,
or at the database level through the <code>CREATE EXTENSION</code> command. For the
latter, you can use the <a href="../declarative_database_management/#managing-extensions-in-a-database"><code>Database</code> resource’s declarative extension management</a>
to ensure consistent, automated extension setup within your PostgreSQL
databases.</p>
<h2 id="benefits">Benefits</h2>
<p>Image volume extensions decouple the distribution of PostgreSQL operand
container images from the distribution of extensions. This eliminates the
need to define and embed extensions at build time within your PostgreSQL
images—a major adoption blocker for PostgreSQL as a containerized workload,
including from a security and supply chain perspective.</p>
<p>As a result, you can:</p>
<ul>
<li>Use the <a href="https://github.com/cloudnative-pg/postgres-containers?tab=readme-ov-file#minimal-images">official PostgreSQL <code>minimal</code> operand images</a>
  provided by CloudNativePG.</li>
<li>Dynamically add the extensions you need to your <code>Cluster</code> definitions,
  without rebuilding or maintaining custom PostgreSQL images.</li>
<li>Reduce your operational surface by using immutable, minimal, and secure base
  images while adding only the extensions required for each workload.</li>
</ul>
<p>Extension images must be built according to the
<a href="#image-specifications">documented specifications</a>.</p>
<h2 id="requirements">Requirements</h2>
<p>To use image volume extensions with CloudNativePG, you need:</p>
<ul>
<li><strong>PostgreSQL 18 or later</strong>, with support for <code>extension_control_path</code>.</li>
<li><strong>Kubernetes 1.33</strong>, with the <code>ImageVolume</code> feature gate enabled.</li>
<li><strong>Container runtime with <code>ImageVolume</code> support</strong>:<ul>
<li><code>containerd</code> v2.1.0 or later, or</li>
<li><code>CRI-O</code> v1.31 or later.</li>
</ul>
</li>
<li><strong>CloudNativePG-compatible extension container images</strong>, ensuring:<ul>
<li>Matching PostgreSQL major version of the <code>Cluster</code> resource.</li>
<li>Compatible operating system distribution of the <code>Cluster</code> resource.</li>
<li>Matching CPU architecture of the <code>Cluster</code> resource.</li>
</ul>
</li>
</ul>
<h2 id="how-it-works">How it works</h2>
<p>Extension images are defined in the <code>.spec.postgresql.extensions</code> stanza of a
<code>Cluster</code> resource, which accepts an ordered list of extensions to be added to
the PostgreSQL cluster.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>For field-level details, see the
<a href="../cloudnative-pg.v1/#postgresql-cnpg-io-v1-ExtensionConfiguration">API reference for <code>ExtensionConfiguration</code></a>.</p>
</div>
<p>Each image volume is mounted at <code>/extensions/&lt;EXTENSION_NAME&gt;</code>.</p>
<p>By default, CloudNativePG automatically manages the relevant GUCs, setting:</p>
<ul>
<li><code>extension_control_path</code> to <code>/extensions/&lt;EXTENSION_NAME&gt;/share</code>, allowing
  PostgreSQL to locate any extension control file within <code>/extensions/&lt;EXTENSION_NAME&gt;/share/extension</code></li>
<li><code>dynamic_library_path</code> to <code>/extensions/&lt;EXTENSION_NAME&gt;/lib</code></li>
</ul>
<p>These values are appended in the order in which the extensions are defined in
the <code>extensions</code> list, ensuring deterministic path resolution within
PostgreSQL. This allows PostgreSQL to discover and load the extension without
requiring manual configuration inside the pod.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Depending on how your extension container images are built and their layout,
you may need to adjust the default <code>extension_control_path</code> and
<code>dynamic_library_path</code> values to match the image structure.</p>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>If the extension image includes shared libraries, they must be compiled
with the same PostgreSQL major version, operating system distribution, and CPU
architecture as the PostgreSQL container image used by your cluster, to ensure
compatibility and prevent runtime issues.</p>
</div>
<h2 id="how-to-add-a-new-extension">How to add a new extension</h2>
<p>Adding an extension to a database in CloudNativePG involves a few steps:</p>
<ol>
<li>Define the extension image in the <code>Cluster</code> resource so that PostgreSQL can
   discover and load it.</li>
<li>Add the library to <a href="../postgresql_conf/#shared-preload-libraries"><code>shared_preload_libraries</code></a>
   if the extension requires it.</li>
<li>Declare the extension in the <code>Database</code> resource where you want it
   installed, if the extension supports <code>CREATE EXTENSION</code>.</li>
</ol>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Avoid making changes to extension images and PostgreSQL configuration
settings (such as <code>shared_preload_libraries</code>) simultaneously.
First, allow the pod to roll out with the new extension image, then update
the PostgreSQL configuration.
This limitation will be addressed in a future release of CloudNativePG.</p>
</div>
<p>For illustration purposes, this guide uses a simple, fictitious extension named
<code>foo</code> that supports <code>CREATE EXTENSION</code>.</p>
<h3 id="adding-a-new-extension-to-a-cluster-resource">Adding a new extension to a <code>Cluster</code> resource</h3>
<p>You can add an <code>ImageVolume</code>-based extension to a <code>Cluster</code> using the
<code>.spec.postgresql.extensions</code> stanza. For example:</p>
<pre><code class="language-yaml">apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: foo-18
spec:
  # ...
  postgresql:
    extensions:
      - name: foo
        image:
          reference: # registry path for your extension image
  # ...
</code></pre>
<p>The <code>name</code> field is <strong>mandatory</strong> and <strong>must be unique within the cluster</strong>, as
it determines the mount path (<code>/extensions/foo</code> in this example). It must
consist of <em>lowercase alphanumeric characters or hyphens (<code>-</code>)</em> and must start
and end with an alphanumeric character.</p>
<p>The <code>image</code> stanza follows the <a href="https://kubernetes.io/docs/tasks/configure-pod-container/image-volumes/">Kubernetes <code>ImageVolume</code> API</a>.
The <code>reference</code> must point to a valid container registry path for the extension
image.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>When a new extension is added to a running <code>Cluster</code>, CloudNativePG will
automatically trigger a <a href="../rolling_update/">rolling update</a> to attach the new
image volume to each pod. Before adding a new extension in production,
ensure you have thoroughly tested it in a staging environment to prevent
configuration issues that could leave your PostgreSQL cluster in an unhealthy
state.</p>
</div>
<p>Once mounted, CloudNativePG will automatically configure PostgreSQL by appending:</p>
<ul>
<li><code>/extensions/foo/share</code> to <code>extension_control_path</code></li>
<li><code>/extensions/foo/lib</code> to <code>dynamic_library_path</code></li>
</ul>
<p>This ensures that the PostgreSQL container is ready to serve the <code>foo</code>
extension when requested by a database, as described in the next section. The
<code>CREATE EXTENSION foo</code> command, triggered automatically during the
<a href="../declarative_database_management/#managing-extensions-in-a-database">reconciliation of the <code>Database</code> resource</a>,
will work without additional configuration, as PostgreSQL will locate:</p>
<ul>
<li>the extension control file at <code>/extensions/foo/share/extension/foo.control</code></li>
<li>the shared library at <code>/extensions/foo/lib/foo.so</code></li>
</ul>
<h3 id="adding-a-new-extension-to-a-database-resource">Adding a new extension to a <code>Database</code> resource</h3>
<p>Once the extension is available in the PostgreSQL instance, you can leverage
declarative databases to <a href="../declarative_database_management/#managing-extensions-in-a-database">manage the lifecycle of your extensions</a>
within the target database.</p>
<p>Continuing with the <code>foo</code> example, you can request the installation of the
<code>foo</code> extension in the <code>app</code> database of the <code>foo-18</code> cluster using the
following resource definition:</p>
<pre><code class="language-yaml">apiVersion: postgresql.cnpg.io/v1
kind: Database
metadata:
  name: foo-app
spec:
  name: app
  owner: app
  cluster:
    name: foo-18
  extensions:
    - name: foo
      version: 1.0
</code></pre>
<p>CloudNativePG will automatically reconcile this resource, executing the
<code>CREATE EXTENSION foo</code> command inside the <code>app</code> database if it is not
already installed, ensuring your desired state is maintained without manual
intervention.</p>
<h2 id="advanced-topics">Advanced Topics</h2>
<p>In some cases, the default expected structure may be insufficient for your
extension image, particularly when:</p>
<ul>
<li>The extension requires additional system libraries.</li>
<li>Multiple extensions are bundled in the same image.</li>
<li>The image uses a custom directory structure.</li>
</ul>
<p>Following the <em>"convention over configuration"</em> paradigm, CloudNativePG allows
you to finely control the configuration of each extension image through the
following fields:</p>
<ul>
<li><code>extension_control_path</code>: A list of relative paths within the container image
  to be appended to PostgreSQL’s <code>extension_control_path</code>, allowing it to
  locate extension control files.</li>
<li><code>dynamic_library_path</code>: A list of relative paths within the container image
  to be appended to PostgreSQL’s <code>dynamic_library_path</code>, enabling it to locate
  shared library files for extensions.</li>
<li><code>ld_library_path</code>: A list of relative paths within the container image to be
  appended to the <code>LD_LIBRARY_PATH</code> environment variable of the instance
  manager process, allowing PostgreSQL to locate required system libraries at
  runtime.</li>
</ul>
<p>This flexibility enables you to support complex or non-standard extension
images while maintaining clarity and predictability.</p>
<h3 id="setting-custom-paths">Setting Custom Paths</h3>
<p>If your extension image does not use the default <code>lib</code> and <code>share</code> directories
for its libraries and control files, you can override the defaults by
explicitly setting <code>extension_control_path</code> and <code>dynamic_library_path</code>.</p>
<p>For example:</p>
<pre><code class="language-yaml">spec:
  postgresql:
    extensions:
      - name: my-extension
        extension_control_path:
          - my/share/path
        dynamic_library_path:
          - my/lib/path
        image:
          reference: # registry path for your extension image
</code></pre>
<p>CloudNativePG will configure PostgreSQL with:</p>
<ul>
<li><code>/extensions/my-extension/my/share/path</code> appended to <code>extension_control_path</code></li>
<li><code>/extensions/my-extension/my/lib/path</code> appended to <code>dynamic_library_path</code></li>
</ul>
<p>This allows PostgreSQL to discover your extension’s control files and shared
libraries correctly, even with a non-standard layout.</p>
<h3 id="multi-extension-images">Multi-extension Images</h3>
<p>You may need to include multiple extensions within the same container image,
adopting a structure where each extension’s files reside in their own
subdirectory.</p>
<p>For example, to package PostGIS and pgRouting together in a single image, each
in its own subdirectory:</p>
<pre><code class="language-yaml"># ...
spec:
  # ...
  postgresql:
    extensions:
      - name: geospatial
        extension_control_path:
          - postgis/share
          - pgrouting/share
        dynamic_library_path:
          - postgis/lib
          - pgrouting/lib
        # ...
        image:
          reference: # registry path for your geospatial image
      # ...
    # ...
  # ...
</code></pre>
<h3 id="including-system-libraries">Including System Libraries</h3>
<p>Some extensions, such as PostGIS, require system libraries that may not be
present in the base PostgreSQL image. To support these requirements, you can
package the necessary libraries within your extension container image and make
them available to PostgreSQL using the <code>ld_library_path</code> field.</p>
<p>For example, if your extension image includes a <code>system</code> directory with the
required libraries:</p>
<pre><code class="language-yaml"># ...
spec:
  # ...
  postgresql:
    extensions:
      - name: postgis
        # ...
        ld_library_path:
          - syslib
        image:
          reference: # registry path for your PostGIS image
      # ...
    # ...
  # ...
</code></pre>
<p>CloudNativePG will set the <code>LD_LIBRARY_PATH</code> environment variable to include
<code>/extensions/postgis/syslib</code>, allowing PostgreSQL to locate and load these
system libraries at runtime.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Since <code>ld_library_path</code> must be set when the PostgreSQL process starts,
changing this value requires a <strong>cluster restart</strong> for the new value to take effect.
CloudNativePG does not currently trigger this restart automatically; you will need to
manually restart the cluster (e.g., using <code>cnpg restart</code>) after modifying <code>ld_library_path</code>.</p>
</div>
<h2 id="image-specifications">Image Specifications</h2>
<p>A standard extension container image for CloudNativePG includes two
required directories at its root:</p>
<ul>
<li><code>/share/</code>: contains an <code>extension</code> subdirectory with the extension control
  file (e.g. <code>&lt;EXTENSION&gt;.control</code>) and the corresponding SQL files.</li>
<li><code>/lib/</code>: contains the extension’s shared library (e.g. <code>&lt;EXTENSION&gt;.so</code>) as
  well as any other required libraries.</li>
</ul>
<p>Following this structure ensures that the extension will be automatically
discoverable and usable by PostgreSQL within CloudNativePG without requiring
manual configuration.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>We encourage PostgreSQL extension developers to publish OCI-compliant extension
images following this layout as part of their artifact distribution, making
their extensions easily consumable within Kubernetes environments.
Ideally, extension images should target a specific operating system
distribution and architecture, be tied to a particular PostgreSQL version, and
be built using the distribution’s native packaging system (for example, using
Debian or RPM packages). This approach ensures consistency, security, and
compatibility with the PostgreSQL images used in your clusters.</p>
</div>
<h2 id="caveats">Caveats</h2>
<p>Currently, adding, removing, or updating an extension image triggers a
restart of the PostgreSQL pods. This behavior is inherited from how
<a href="https://kubernetes.io/docs/tasks/configure-pod-container/image-volumes/">image volumes</a>
work in Kubernetes.</p>
<p>Before performing an extension update, ensure you have:</p>
<ul>
<li>Thoroughly tested the update process in a staging environment.</li>
<li>Verified that the extension image contains the required upgrade path between
  the currently installed version and the target version.</li>
<li>Updated the <code>version</code> field for the extension in the relevant <code>Database</code>
  resource definition to align with the new version in the image.</li>
</ul>
<p>These steps help prevent downtime or data inconsistencies in your PostgreSQL
clusters during extension updates.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../container_images/" class="btn btn-neutral float-left" title="Container Image Requirements"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../cnpg_i/" class="btn btn-neutral float-right" title="CNPG-I">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>Copyright © CloudNativePG a Series of LF Projects, LLC</p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../container_images/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../cnpg_i/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
