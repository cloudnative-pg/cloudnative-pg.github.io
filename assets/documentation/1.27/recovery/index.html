<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="The CloudNativePG Contributors" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Recovery - CloudNativePG v1.27</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/override.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Recovery";
        var mkdocs_page_input_path = "recovery.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> CloudNativePG v1.27
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">CloudNativePG</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../before_you_start/">Before you start</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../use_cases/">Use cases</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../architecture/">Architecture</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../installation_upgrade/">Installation and upgrades</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../quickstart/">Quickstart</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../image_catalog/">Image Catalog</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../bootstrap/">Bootstrap</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../database_import/">Importing Postgres databases</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../security/">Security</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../instance_manager/">Postgres Instance Manager</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../scheduling/">Scheduling</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../resource_management/">Resource management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../failure_modes/">Failure Modes</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../rolling_update/">Rolling updates</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../replication/">Replication</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../logical_replication/">Logical Replication</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../backup/">Backup</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../wal_archiving/">WAL archiving</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">Recovery</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#recovery-from-an-object-store-with-the-barman-cloud-plugin">Recovery from an Object Store with the Barman Cloud Plugin</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#recovery-from-volumesnapshot-objects">Recovery from VolumeSnapshot Objects</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#recovery-from-a-backup-object">Recovery from a Backup object</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#additional-considerations">Additional Considerations</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#point-in-time-recovery-pitr">Point in time recovery (PITR)</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#pitr-from-an-object-store">PITR from an object store</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#point-in-time-recovery-pitr-from-volumesnapshot-objects">Point-in-Time Recovery (PITR) from VolumeSnapshot Objects</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#recovery-targets">Recovery targets</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#configure-the-application-database">Configure the application database</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#how-recovery-works-under-the-hood">How recovery works under the hood</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#restoring-into-a-cluster-with-a-backup-section">Restoring into a Cluster with a Backup Section</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../service_management/">Service management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../postgresql_conf/">PostgreSQL Configuration</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../declarative_role_management/">PostgreSQL Role management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../declarative_database_management/">PostgreSQL Database management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../tablespaces/">Tablespaces</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../operator_conf/">Operator configuration</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../cluster_conf/">Instance Pod configuration</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../storage/">Storage</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../labels_annotations/">Labels and Annotations</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../monitoring/">Monitoring</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../logging/">Logging</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../certificates/">Certificates</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../ssl_connections/">Client TLS/SSL connections</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../applications/">Connecting from an application</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../connection_pooling/">Connection Pooling</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../replica_cluster/">Replica clusters</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../kubernetes_upgrade/">Kubernetes upgrade and maintenance</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../postgres_upgrades/">PostgreSQL upgrades</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../kubectl-plugin/">Kubectl Plugin</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../failover/">Automated failover</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../troubleshooting/">Troubleshooting</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../fencing/">Fencing</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../declarative_hibernation/">Declarative hibernation</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../postgis/">PostGIS</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../e2e/">End-to-End Tests</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../container_images/">Container Image Requirements</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../imagevolume_extensions/">Image Volume Extensions</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../cnpg_i/">CNPG-I</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../operator_capability_levels/">Operator capability levels</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../controller/">Custom Pod Controller</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../samples/">Examples</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../networking/">Networking</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../benchmarking/">Benchmarking</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../faq/">Frequently Asked Questions (FAQ)</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../cloudnative-pg.v1/">API Reference</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../supported_releases/">Supported releases</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../preview_version/">Preview Versions</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../release_notes/">Release notes</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">CNCF Projects Integrations</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../cncf-projects/external-secrets/">External Secrets</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cncf-projects/cilium/">Cilium</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Appendixes</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../appendixes/backup_volumesnapshot/">Appendix A - Backup on volume snapshots</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../appendixes/backup_barmanobjectstore/">Appendix B - Backup on object stores</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../appendixes/object_stores/">Appendix C - Common object stores for backups</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">CloudNativePG v1.27</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Recovery</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="recovery">Recovery</h1>
<!-- SPDX-License-Identifier: CC-BY-4.0 -->

<p>In PostgreSQL, <strong>recovery</strong> refers to the process of starting an instance from
an existing physical backup. PostgreSQL's recovery system is robust and
feature-rich, supporting <strong>Point-In-Time Recovery (PITR)</strong>—the ability to
restore a cluster to any specific moment, from the earliest available backup to
the latest archived WAL file.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>A valid WAL archive is required to perform PITR.</p>
</div>
<p>In CloudNativePG, recovery is <strong>not performed in-place</strong> on an existing
cluster. Instead, it is used to <strong>bootstrap a new cluster</strong> from a physical
backup.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For more details on configuring the <code>bootstrap</code> stanza, refer to
<a href="../bootstrap/">Bootstrap</a>.</p>
</div>
<p>The <code>recovery</code> bootstrap mode allows you to initialize a cluster from a
physical base backup and replay the associated WAL files to bring the system to
a consistent and optionally point-in-time state.</p>
<p>CloudNativePG supports recovery via:</p>
<ul>
<li>A <strong>pluggable backup and recovery interface (CNPG-I)</strong>, enabling integration
  with external tools such as the <a href="https://cloudnative-pg.io/plugin-barman-cloud/">Barman Cloud Plugin</a>.</li>
<li><strong>Native recovery from volume snapshots</strong>, where supported by the underlying
  Kubernetes storage infrastructure.</li>
<li><strong>Native recovery from object stores via Barman Cloud</strong>, which is
  <strong>deprecated</strong> as of version 1.26 in favor of the plugin-based approach.</li>
</ul>
<p>With the deprecation of native Barman Cloud support in version 1.26, this
section now focuses on two supported recovery methods: using the <strong>Barman Cloud
Plugin</strong> for recovery from object stores, and the <strong>native interface</strong> for
recovery from volume snapshots.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>For legacy documentation, see
<a href="../appendixes/backup_barmanobjectstore/#recovery-from-an-object-store">Appendix B – Recovery from an Object Store</a>.</p>
</div>
<h2 id="recovery-from-an-object-store-with-the-barman-cloud-plugin">Recovery from an Object Store with the Barman Cloud Plugin</h2>
<p>This section outlines how to recover a PostgreSQL cluster from an object store
using the recommended Barman Cloud Plugin.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The object store must contain backup data produced by a CloudNativePG
<code>Cluster</code>—either using the <strong>deprecated native Barman Cloud integration</strong> or
the <strong>Barman Cloud Plugin</strong>.</p>
</div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>For full details, refer to the
<a href="https://cloudnative-pg.io/plugin-barman-cloud/docs/concepts/#recovery-of-a-postgres-cluster">“Recovery of a Postgres Cluster” section in the Barman Cloud Plugin documentation</a>.</p>
</div>
<p>Begin by defining the object store that holds both your base backups and WAL
files. The Barman Cloud Plugin uses a custom <code>ObjectStore</code> resource for this
purpose. The following example shows how to configure one for Azure Blob
Storage:</p>
<pre><code class="language-yaml">apiVersion: barmancloud.cnpg.io/v1
kind: ObjectStore
metadata:
  name: cluster-example-backup
spec:
  configuration:
    destinationPath: https://STORAGEACCOUNTNAME.blob.core.windows.net/CONTAINERNAME/
    azureCredentials:
      storageAccount:
        name: recovery-object-store-secret
        key: storage_account_name
      storageKey:
        name: recovery-object-store-secret
        key: storage_account_key
    wal:
      maxParallel: 8
</code></pre>
<p>Next, configure the <code>Cluster</code> resource to use the <code>ObjectStore</code> you defined. In
the <code>bootstrap</code> section, specify the recovery source, and define an
<code>externalCluster</code> entry that references the plugin:</p>
<pre><code class="language-yaml">apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: cluster-restore
spec:
  [...]

  superuserSecret:
    name: superuser-secret

  bootstrap:
    recovery:
      source: origin

  externalClusters:
    - name: origin
      plugin:
        name: barman-cloud.cloudnative-pg.io
        parameters:
          barmanObjectName: cluster-example-backup
          serverName: cluster-example
</code></pre>
<h2 id="recovery-from-volumesnapshot-objects">Recovery from <code>VolumeSnapshot</code> Objects</h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>When creating replicas after recovering a primary instance from a
<code>VolumeSnapshot</code>, the operator may fall back to using <code>pg_basebackup</code> to
synchronize them. This process can be significantly slower—especially for large
databases—because it involves a full base backup. This limitation will be
addressed in the future with support for online backups and PVC cloning in
the scale-up process.</p>
</div>
<p>CloudNativePG allows you to create a new cluster from a <code>VolumeSnapshot</code> of a
<code>PersistentVolumeClaim</code> (PVC) that belongs to an existing <code>Cluster</code>.
These snapshots are created using the declarative API for
<a href="../appendixes/backup_volumesnapshot/">volume snapshot backups</a>.</p>
<p>To complete the recovery process, the new cluster must also reference an
external cluster that provides access to the WAL archive needed to reapply
changes and finalize the recovery.</p>
<p>The following example shows a cluster being recovered using both a
<code>VolumeSnapshot</code> for the base backup and a WAL archive accessed through the
Barman Cloud Plugin:</p>
<pre><code class="language-yaml">apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: cluster-restore
spec:
  [...]

  bootstrap:
    recovery:
      source: origin
      volumeSnapshots:
        storage:
          name: &lt;snapshot name&gt;
          kind: VolumeSnapshot
          apiGroup: snapshot.storage.k8s.io

  externalClusters:
    - name: origin
      plugin:
        name: barman-cloud.cloudnative-pg.io
        parameters:
          barmanObjectName: cluster-example-backup
          serverName: cluster-example
</code></pre>
<p>In case the backed-up cluster was using a separate PVC to store the WAL files,
the recovery must include that too:</p>
<pre><code class="language-yaml">apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: cluster-restore
spec:
  [...]

  bootstrap:
    recovery:
      volumeSnapshots:
        storage:
          name: &lt;snapshot name&gt;
          kind: VolumeSnapshot
          apiGroup: snapshot.storage.k8s.io

        walStorage:
          name: &lt;snapshot name&gt;
          kind: VolumeSnapshot
          apiGroup: snapshot.storage.k8s.io
</code></pre>
<p>The previous example assumes that the application database and its owning user
are named <code>app</code> by default. If the PostgreSQL cluster being restored uses
different names, you must specify these names before exiting the recovery phase,
as documented in <a href="#configure-the-application-database">"Configure the application database"</a>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If bootstrapping a replica-mode cluster from snapshots, to leverage
snapshots for the standby instances and not just the primary,
we recommend that you:</p>
<ol>
<li>Start with a single instance replica cluster. The primary instance will
  be recovered using the snapshot, and available WALs from the source cluster.</li>
<li>Take a snapshot of the primary in the replica cluster.</li>
<li>Increase the number of instances in the replica cluster as desired.</li>
</ol>
</div>
<h2 id="recovery-from-a-backup-object">Recovery from a <code>Backup</code> object</h2>
<p>If a <code>Backup</code> resource is already available in the namespace in which you need
to create the cluster, you can specify the name using
<code>.spec.bootstrap.recovery.backup.name</code>, as in the following example:</p>
<pre><code class="language-yaml">apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: cluster-example-initdb
spec:
  instances: 3

  bootstrap:
    recovery:
      backup:
        name: backup-example

  storage:
    size: 1Gi
</code></pre>
<p>This bootstrap method allows you to specify just a reference to the
backup that needs to be restored.</p>
<p>The previous example assumes that the application database and its owning user
are named <code>app</code> by default. If the PostgreSQL cluster being restored uses
different names, you must specify these names before exiting the recovery phase,
as documented in <a href="#configure-the-application-database">"Configure the application database"</a>.</p>
<h2 id="additional-considerations">Additional Considerations</h2>
<p>Whether you recover from an object store, a volume snapshot, or an existing
<code>Backup</code> resource, no changes to the database, including the catalog, are
permitted until the <code>Cluster</code> is fully promoted to primary and accepts write
operations. This restriction includes any role overrides, which are deferred
until the <code>Cluster</code> transitions to primary.
As a result, the following considerations apply:</p>
<ul>
<li>The application database name and user are copied from the backup being
  restored. The operator does not currently back up the underlying secrets, as
  this is part of the usual maintenance activity of the Kubernetes cluster.</li>
<li>To preserve the original postgres user password, configure
  <code>enableSuperuserAccess</code> and supply a <code>superuserSecret</code>.</li>
</ul>
<p>By default, recovery continues up to the latest available WAL on the default
target timeline (<code>latest</code>). You can optionally specify a <code>recoveryTarget</code> to
perform a point-in-time recovery (see <a href="#point-in-time-recovery-pitr">Point in Time Recovery (PITR)</a>).</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Consider using the <code>barmanObjectStore.wal.maxParallel</code> option to speed
up WAL fetching from the archive by concurrently downloading the transaction
logs from the recovery object store.</p>
</div>
<h2 id="point-in-time-recovery-pitr">Point in time recovery (PITR)</h2>
<p>Instead of replaying all the WALs up to the latest one, after extracting a base
backup, you can ask PostgreSQL to stop replaying WALs at any given point in
time. PostgreSQL uses this technique to achieve PITR. The presence of a WAL
archive is mandatory.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>PITR requires you to specify a recovery target by using the options
described in <a href="#recovery-targets">Recovery targets</a>.</p>
</div>
<p>The operator generates the configuration parameters required for this
feature to work if you specify a recovery target.</p>
<h3 id="pitr-from-an-object-store">PITR from an object store</h3>
<p>This example uses the same recovery object store in Azure defined earlier for
the Barman Cloud plugin, containing both the base backups and the WAL archive.
The recovery target is based on a requested timestamp.</p>
<pre><code class="language-yaml">apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: cluster-restore-pitr
spec:
  instances: 3

  storage:
    size: 5Gi

  bootstrap:
    recovery:
      # Recovery object store containing WAL archive and base backups
      source: origin
      recoveryTarget:
        # Time base target for the recovery
        targetTime: &quot;2023-08-11 11:14:21.00000+02&quot;

  externalClusters:
    - name: origin
      plugin:
        name: barman-cloud.cloudnative-pg.io
        parameters:
          barmanObjectName: cluster-example-backup
          serverName: cluster-example
</code></pre>
<p>In this example, you had to specify only the <code>targetTime</code> in the form of a
timestamp. You didn't have to specify the base backup from which to start the
recovery.</p>
<p>The <code>backupID</code> option is the one that allows you to specify the base backup
from which to initiate the recovery process. By default, this value is
empty.</p>
<p>If you assign a value to it (in the form of a Barman backup ID), the operator
uses that backup as the base for the recovery.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>You need to make sure that such a backup exists and is accessible.</p>
</div>
<p>If you don't specify the backup ID, the operator detects the base backup for
the recovery as follows:</p>
<ul>
<li>When you use <code>targetTime</code> or <code>targetLSN</code>, the operator selects the closest
  backup that was completed before that target.</li>
<li>Otherwise, the operator selects the last available backup, in chronological
  order.</li>
</ul>
<h3 id="point-in-time-recovery-pitr-from-volumesnapshot-objects">Point-in-Time Recovery (PITR) from <code>VolumeSnapshot</code> Objects</h3>
<p>The following example demonstrates how to perform a <strong>Point-in-Time Recovery (PITR)</strong> using:</p>
<ul>
<li>A Kubernetes <code>VolumeSnapshot</code> of the <code>PGDATA</code> directory, which provides the
  base backup. This snapshot is specified in the <code>recovery.volumeSnapshots</code>
  section and is named <code>test-snapshot-1</code>.</li>
<li>A recovery object store (in this case, MinIO) containing the archived WAL
  files. The object store is defined via a Barman Cloud Plugin <code>ObjectStore</code>
  resource (not shown here), and referenced using the <code>recovery.source</code> field,
  which points to an external cluster configuration.</li>
</ul>
<p>The cluster will be restored to a specific point in time using the
<code>recoveryTarget.targetTime</code> option.</p>
<pre><code class="language-yaml">apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: cluster-example-snapshot
spec:
  # ...
  bootstrap:
    recovery:
      source: origin
      volumeSnapshots:
        storage:
          name: test-snapshot-1
          kind: VolumeSnapshot
          apiGroup: snapshot.storage.k8s.io
      recoveryTarget:
        targetTime: &quot;2023-07-06T08:00:39&quot;
  externalClusters:
    - name: origin
      plugin:
        name: barman-cloud.cloudnative-pg.io
        parameters:
          barmanObjectName: minio-backup
          serverName: cluster-example
</code></pre>
<p>This setup enables CloudNativePG to restore the base data from a volume
snapshot and apply WAL segments from the object store to reach the desired
recovery target.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the backed-up cluster had <code>walStorage</code> enabled, you also must specify
the volume snapshot containing the <code>PGWAL</code> directory, as mentioned in
<a href="#recovery-from-volumesnapshot-objects">Recovery from VolumeSnapshot objects</a>.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>It's your responsibility to ensure that the end time of the base backup in
the volume snapshot is before the recovery target timestamp.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If you added or removed a <a href="../tablespaces/">tablespace</a> in your cluster
since the last base backup, replaying the WAL will fail. You need a base
backup between the time of the tablespace change and the recovery target
timestamp.</p>
</div>
<h3 id="recovery-targets">Recovery targets</h3>
<p>Here are the recovery target criteria you can use:</p>
<dl>
<dt>targetTime</dt>
<dd>Time stamp up to which recovery proceeds, expressed in
   <a href="https://datatracker.ietf.org/doc/html/rfc3339">RFC 3339</a> format.
   (The precise stopping point is also influenced by the <code>exclusive</code> option.)</dd>
</dl>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>PostgreSQL recovery will stop when it encounters the first transaction that
occurs after the specified time. If no such transaction exists after the
target time, the recovery process will fail.</p>
</div>
<dl>
<dt>targetXID</dt>
<dd>Transaction ID up to which recovery proceeds.
   (The precise stopping point is also influenced by the <code>exclusive</code> option.)
   Keep in mind that while transaction IDs are assigned sequentially at
   transaction start, transactions can complete in a different numeric order.
   The transactions that are recovered are those that committed before
   (and optionally including) the specified one.</dd>
<dt>targetName</dt>
<dd>Named restore point (created with <code>pg_create_restore_point()</code>) to which
   recovery proceeds.</dd>
<dt>targetLSN</dt>
<dd>LSN of the write-ahead log location up to which recovery proceeds.
   (The precise stopping point is also influenced by the <code>exclusive</code> option.)</dd>
<dt>targetImmediate</dt>
<dd>Recovery ends as soon as a consistent state is reached, that is, as early
   as possible. When restoring from an online backup, this means the point where
   taking the backup ended.</dd>
</dl>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The operator can retrieve the closest backup when you specify either
<code>targetTime</code> or <code>targetLSN</code>. However, this isn't possible for the remaining
targets: <code>targetName</code>, <code>targetXID</code>, and <code>targetImmediate</code>. In such cases, it's
mandatory to specify <code>backupID</code>.</p>
</div>
<p>This example uses a <code>targetName</code>-based recovery target:</p>
<pre><code class="language-yaml">apiVersion: postgresql.cnpg.io/v1
kind: Cluster
[...]
  bootstrap:
    recovery:
      source: origin
      recoveryTarget:
        backupID: 20220616T142236
        targetName: 'restore_point_1'
[...]
</code></pre>
<p>You can choose only a single one among the targets in each <code>recoveryTarget</code>
configuration.</p>
<p>Additionally, you can specify <code>targetTLI</code> to force recovery to a specific
timeline.</p>
<p>By default, the previous parameters are considered to be inclusive, stopping
just after the recovery target, matching
<a href="https://www.postgresql.org/docs/current/runtime-config-wal.html#GUC-RECOVERY-TARGET-INCLUSIVE">the behavior in PostgreSQL</a>.</p>
<p>You can request exclusive behavior, stopping right before the recovery target,
by setting the <code>exclusive</code> parameter to <code>true</code>. The following example shows
this behavior, relying on a blob container in Azure for both base backups and
the WAL archive:</p>
<pre><code class="language-yaml">apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: cluster-restore-pitr
spec:
  instances: 3

  storage:
    size: 5Gi

  bootstrap:
    recovery:
      source: origin
      recoveryTarget:
        backupID: 20220616T142236
        targetName: &quot;maintenance-activity&quot;
        exclusive: true

  externalClusters:
    - name: origin
      plugin:
        name: barman-cloud.cloudnative-pg.io
        parameters:
          barmanObjectName: cluster-example-backup
          serverName: cluster-example
</code></pre>
<h2 id="configure-the-application-database">Configure the application database</h2>
<p>For the recovered cluster, you can configure the application database name and
credentials with additional configuration. To update application database
credentials, you can generate your own passwords, store them as secrets, and
update the database to use the secrets. Or you can also let the operator
generate a secret with a randomly secure password for use.
See <a href="../bootstrap/#bootstrap-an-empty-cluster-initdb">Bootstrap an empty cluster</a>
for more information about secrets.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>While the <code>Cluster</code> is in recovery mode, no changes to the database,
including the catalog, are permitted. This restriction includes any role
overrides, which are deferred until the <code>Cluster</code> transitions to primary.
During this phase, users remain as defined in the source cluster.</p>
</div>
<p>The following example configures the <code>app</code> database with the owner <code>app</code> and
the password stored in the provided secret <code>app-secret</code>, following the
bootstrap from a live cluster.</p>
<pre><code class="language-yaml">apiVersion: postgresql.cnpg.io/v1
kind: Cluster
[...]
spec:
  bootstrap:
    recovery:
      database: app
      owner: app
      secret:
        name: app-secret
      [...]
</code></pre>
<p>With the above configuration, the following will happen only <strong>after recovery is
completed</strong>:</p>
<ol>
<li>If the <code>app</code> database does not exist, it will be created.</li>
<li>If the <code>app</code> user does not exist, it will be created.</li>
<li>If the <code>app</code> user is not the owner of the <code>app</code> database, ownership will be
   granted to the <code>app</code> user.</li>
<li>If the <code>owner</code> value matches the <code>username</code> value in the secret, the
   password for the application user (the <code>app</code> user in this case) will be
   updated to the <code>password</code> value in the secret.</li>
</ol>
<h2 id="how-recovery-works-under-the-hood">How recovery works under the hood</h2>
<!-- TODO: do we need this section? -->
<!-- Also, "under the hood" is an idiom and should be replaced with something more precise -->

<p>You can use the data uploaded to the object storage to <em>bootstrap</em> a new
cluster from an existing backup. The operator orchestrates the recovery process
using the <code>barman-cloud-restore</code> tool (for the base backup) and the
<code>barman-cloud-wal-restore</code> tool (for WAL files, including parallel support, if
requested).</p>
<p>For details and instructions on the <code>recovery</code> bootstrap method, see
<a href="../bootstrap/#bootstrap-from-a-backup-recovery">Bootstrap from a backup</a>.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>If you're not familiar with how
<a href="https://www.postgresql.org/docs/current/continuous-archiving.html#BACKUP-PITR-RECOVERY">PostgreSQL PITR</a>
works, we suggest that you configure the recovery cluster as the original
one when it comes to <code>.spec.postgresql.parameters</code>. Once the new cluster is
restored, you can then change the settings as desired.</p>
</div>
<p>The way it works is that the operator injects an init container in the first
instance of the new cluster, and the init container starts recovering the
backup from the object storage.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The duration of the base backup copy in the new PVC depends on
the size of the backup, as well as the speed of both the network and the
storage.</p>
</div>
<p>When the base backup recovery process is complete, the operator starts the
Postgres instance in recovery mode. In this phase, PostgreSQL is up, though not
able to accept connections, and the pod is healthy according to the
liveness probe. By way of the <code>restore_command</code>, PostgreSQL starts fetching WAL
files from the archive. You can speed up this phase by setting the
<code>maxParallel</code> option and enabling the parallel WAL restore capability.</p>
<p>This phase terminates when PostgreSQL reaches the target, either the end of the
WAL or the required target in case of PITR. You can optionally specify a
<code>recoveryTarget</code> to perform a PITR. If left unspecified, the recovery continues
up to the latest available WAL on the default target timeline (<code>latest</code>).</p>
<p>Once the recovery is complete, the operator sets the required superuser
password into the instance. The new primary instance starts as usual, and the
remaining instances join the cluster as replicas.</p>
<p>The process is transparent for the user and is managed by the instance manager
running in the pods.</p>
<h2 id="restoring-into-a-cluster-with-a-backup-section">Restoring into a Cluster with a Backup Section</h2>
<p>When restoring a cluster, the manifest may include a <code>plugins</code> section with
Barman Cloud plugin pointing to a <em>backup</em> object store resource. This enables
the newly created cluster to begin archiving WAL files and taking backups
immediately after recovery—provided backup policies are configured.</p>
<p>Avoid reusing the same <code>ObjectStore</code> configuration for both <em>backup</em> and
<em>recovery</em> in the same cluster. If you must, ensure that each cluster uses a
unique <code>serverName</code> to prevent accidental overwrites of backup or WAL archive
data.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>CloudNativePG includes a safety check to prevent a cluster from overwriting
existing data in a shared storage bucket. If a conflict is detected, the
cluster remains in the <code>Setting up primary</code> state, and the associated pods will
fail with an error. The pod logs will display:
<code>ERROR: WAL archive check failed for server recoveredCluster: Expected empty archive</code>.</p>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>You can bypass this safety check by setting the
<code>cnpg.io/skipEmptyWalArchiveCheck</code> annotation to <code>enabled</code> on the recovered
cluster. However, this is strongly discouraged unless you are highly
familiar with PostgreSQL's recovery process. Skipping the check incorrectly can
lead to severe data loss. Use with caution and only in expert scenarios.</p>
</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../wal_archiving/" class="btn btn-neutral float-left" title="WAL archiving"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../service_management/" class="btn btn-neutral float-right" title="Service management">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>Copyright © CloudNativePG a Series of LF Projects, LLC</p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../wal_archiving/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../service_management/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
