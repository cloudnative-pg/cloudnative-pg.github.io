<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="The CloudNativePG Contributors" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Connection pooling - CloudNativePG</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/override.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Connection pooling";
        var mkdocs_page_input_path = "connection_pooling.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> CloudNativePG
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">CloudNativePG</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../before_you_start/">Before You Start</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../use_cases/">Use cases</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../architecture/">Architecture</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../installation_upgrade/">Installation and upgrades</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../quickstart/">Quickstart</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../image_catalog/">Image Catalog</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../bootstrap/">Bootstrap</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../database_import/">Importing Postgres databases</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../security/">Security</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../instance_manager/">Postgres instance manager</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../scheduling/">Scheduling</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../resource_management/">Resource management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../failure_modes/">Failure Modes</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../rolling_update/">Rolling Updates</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../replication/">Replication</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../backup/">Backup</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../backup_barmanobjectstore/">Backup on object stores</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../wal_archiving/">WAL archiving</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../backup_volumesnapshot/">Backup on volume snapshots</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../recovery/">Recovery</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../postgresql_conf/">PostgreSQL Configuration</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../declarative_role_management/">Database Role Management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../tablespaces/">Tablespaces</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../operator_conf/">Operator configuration</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../cluster_conf/">Instance pod configuration</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../storage/">Storage</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../labels_annotations/">Labels and annotations</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../monitoring/">Monitoring</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../logging/">Logging</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../certificates/">Certificates</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../ssl_connections/">Client TLS/SSL connections</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../applications/">Connecting from an application</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">Connection pooling</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#architecture">Architecture</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#quick-start">Quick start</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#pooler-resource-lifecycle">Pooler resource lifecycle</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#security">Security</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#certificates">Certificates</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#authentication">Authentication</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#pod-templates">Pod templates</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#service-template">Service Template</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#high-availability-ha">High availability (HA)</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#pgbouncer-configuration-options">PgBouncer configuration options</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#monitoring">Monitoring</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#logging">Logging</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#pausing-connections">Pausing connections</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#limitations">Limitations</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#single-postgresql-cluster">Single PostgreSQL cluster</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#controlled-configurability">Controlled configurability</a>
    </li>
        </ul>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../replica_cluster/">Replica clusters</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../kubernetes_upgrade/">Kubernetes Upgrade and Maintenance</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../expose_pg_services/">Exposing Postgres Services</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../kubectl-plugin/">Kubectl Plugin</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../failover/">Automated failover</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../troubleshooting/">Troubleshooting</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../fencing/">Fencing</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../declarative_hibernation/">Declarative hibernation</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../postgis/">PostGIS</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../e2e/">End-to-End Tests</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../container_images/">Container Image Requirements</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../operator_capability_levels/">Operator capability levels</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../controller/">Custom Pod Controller</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../samples/">Examples</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../networking/">Networking</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../benchmarking/">Benchmarking</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../commercial_support/">Commercial support</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../faq/">Frequently Asked Questions (FAQ)</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../cloudnative-pg.v1/">API Reference</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../supported_releases/">Supported releases</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../release_notes/">Release notes</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Appendixes</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../appendixes/object_stores/">Appendix A - Common object stores for backups</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">CloudNativePG</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Connection pooling</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="connection-pooling">Connection pooling</h1>
<p>CloudNativePG provides native support for connection pooling with
<a href="https://www.pgbouncer.org/">PgBouncer</a>, one of the most popular open source
connection poolers for PostgreSQL, through the <code>Pooler</code> custom resource definition (CRD).</p>
<p>In brief, a pooler in CloudNativePG is a deployment of PgBouncer pods that sits
between your applications and a PostgreSQL service, for example, the <code>rw</code>
service. It creates a separate, scalable, configurable, and highly available
database access layer.</p>
<h2 id="architecture">Architecture</h2>
<p>The following diagram highlights how introducing a database access layer based
on PgBouncer changes the architecture of CloudNativePG. Instead of directly
connecting to the PostgreSQL primary service, applications can connect to the
equivalent service for PgBouncer. This ability enables reuse of existing
connections for faster performance and better resource management on the
PostgreSQL side.</p>
<p><img alt="Applications writing to the single primary via PgBouncer" src="../images/pgbouncer-architecture-rw.png" /></p>
<h2 id="quick-start">Quick start</h2>
<p>This example helps to show how CloudNativePG implements a PgBouncer
pooler:</p>
<pre><code class="language-yaml">apiVersion: postgresql.cnpg.io/v1
kind: Pooler
metadata:
  name: pooler-example-rw
spec:
  cluster:
    name: cluster-example

  instances: 3
  type: rw
  pgbouncer:
    poolMode: session
    parameters:
      max_client_conn: &quot;1000&quot;
      default_pool_size: &quot;10&quot;
</code></pre>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The pooler name can't be the same as any cluster name in the same namespace.</p>
</div>
<p>This example creates a <code>Pooler</code> resource called <code>pooler-example-rw</code> 
that's strictly associated with the Postgres <code>Cluster</code> resource called
<code>cluster-example</code>. It points to the primary, identified by the read/write
service (<code>rw</code>, therefore <code>cluster-example-rw</code>).</p>
<p>The <code>Pooler</code> resource must live in the same namespace as the Postgres cluster.
It consists of a Kubernetes deployment of 3 pods running the
<a href="https://ghcr.io/cloudnative-pg/pgbouncer">latest stable image of PgBouncer</a>,
configured with the <a href="https://www.pgbouncer.org/config.html#pool-mode"><code>session</code> pooling mode</a>
and accepting up to 1000 connections each. The default pool size is 10
user/database pairs toward PostgreSQL.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The <code>Pooler</code> resource sets only the <code>*</code> fallback database in PgBouncer. This setting means that
that all parameters in the connection strings passed from the client are
relayed to the PostgreSQL server. For details, see <a href="https://www.pgbouncer.org/config.html#section-databases">"Section [databases]"
in the PgBouncer documentation</a>.</p>
</div>
<p>CloudNativePG also creates a secret with the same name as the pooler containing
the configuration files used with PgBouncer.</p>
<div class="admonition seealso">
<p class="admonition-title">API reference</p>
<p>For details, see <a href="../cloudnative-pg.v1/#postgresql-cnpg-io-v1-PgBouncerSpec"><code>PgBouncerSpec</code></a>
in the API reference.</p>
</div>
<h2 id="pooler-resource-lifecycle">Pooler resource lifecycle</h2>
<p><code>Pooler</code> resources aren't cluster-managed resources. You create poolers
manually when they're needed. You can also deploy multiple poolers per
PostgreSQL cluster.</p>
<p>What's important is that the life cycles of the <code>Cluster</code> and the <code>Pooler</code>
resources are currently independent. Deleting the cluster doesn't imply the
deletion of the pooler, and vice versa.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Once you know how a pooler works, you have full freedom in terms of
possible architectures. You can have clusters without poolers, clusters with
a single pooler, or clusters with several poolers, that is, one per application.</p>
</div>
<h2 id="security">Security</h2>
<p>Any PgBouncer pooler is transparently integrated with CloudNativePG support for
in-transit encryption by way of TLS connections, both on the client
(application) and server (PostgreSQL) side of the pool.</p>
<p>Specifically, PgBouncer reuses the certificates of the PostgreSQL server. It
also uses TLS client certificate authentication to connect to the PostgreSQL
server to run the <code>auth_query</code> for clients' password authentication (see
<a href="#authentication">Authentication</a>).</p>
<p>Containers run as the pgbouncer system user, and access to the <code>pgbouncer</code>
database is allowed only by way of local connections, through peer authentication.</p>
<h3 id="certificates">Certificates</h3>
<p>By default, a PgBouncer pooler uses the same certificates that are used by the
cluster. However, if you provide those certificates, the pooler accepts secrets
with the following formats:</p>
<ol>
<li>Basic Auth</li>
<li>TLS</li>
<li>Opaque</li>
</ol>
<p>In the Opaque case, it looks for the following specific keys that need to be used:</p>
<ul>
<li>tls.crt</li>
<li>tls.key</li>
</ul>
<p>So you can treat this secret as a TLS secret, and start from there.</p>
<h2 id="authentication">Authentication</h2>
<p>Password-based authentication is the only supported method for clients of
PgBouncer in CloudNativePG.</p>
<p>Internally, the implementation relies on PgBouncer's <code>auth_user</code> and
<code>auth_query</code> options. Specifically, the operator:</p>
<ul>
<li>Creates a standard user called <code>cnpg_pooler_pgbouncer</code> in the PostgreSQL server</li>
<li>Creates the lookup function in the <code>postgres</code> database and grants execution
  privileges to the cnpg_pooler_pgbouncer user (PoLA)</li>
<li>Issues a TLS certificate for this user</li>
<li>Sets <code>cnpg_pooler_pgbouncer</code> as the <code>auth_user</code></li>
<li>Configures PgBouncer to use the TLS certificate to authenticate
  <code>cnpg_pooler_pgbouncer</code> against the PostgreSQL server</li>
<li>Removes all the above when it detects that a cluster doesn't have
  any pooler associated to it</li>
</ul>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>If you specify your own secrets, the operator doesn't automatically
integrate the pooler.</p>
</div>
<p>To manually integrate the pooler, if you specified your own
secrets, you must run the following queries from inside your cluster.</p>
<p>First, you must create the role:</p>
<pre><code class="language-sql">CREATE ROLE cnpg_pooler_pgbouncer WITH LOGIN;
</code></pre>
<p>Then, for each application database, grant the permission for
<code>cnpg_pooler_pgbouncer</code> to connect to it:</p>
<pre><code class="language-sql">GRANT CONNECT ON DATABASE { database name here } TO cnpg_pooler_pgbouncer;
</code></pre>
<p>Finally, as a <em>superuser</em> connect in each application database, and then create
the authentication function inside each of the application databases:</p>
<pre><code class="language-sql">CREATE OR REPLACE FUNCTION public.user_search(uname TEXT)
  RETURNS TABLE (usename name, passwd text)
  LANGUAGE sql SECURITY DEFINER AS
  'SELECT usename, passwd FROM pg_catalog.pg_shadow WHERE usename=$1;';

REVOKE ALL ON FUNCTION public.user_search(text)
  FROM public;

GRANT EXECUTE ON FUNCTION public.user_search(text)
  TO cnpg_pooler_pgbouncer;
</code></pre>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Given that <code>user_search</code> is a <code>SECURITY DEFINER</code> function, you need to
create it through a role with <code>SUPERUSER</code> privileges, such as the <code>postgres</code>
user.</p>
</div>
<h2 id="pod-templates">Pod templates</h2>
<p>You can take advantage of pod templates specification in the <code>template</code>
section of a <code>Pooler</code> resource. For details, see 
<a href="../cloudnative-pg.v1/#postgresql-cnpg-io-v1-PoolerSpec"><code>PoolerSpec</code></a> in the API reference.</p>
<p>Using templates, you can configure pods as you like, including fine control
over affinity and anti-affinity rules for pods and nodes. By default,
containers use images from <code>ghcr.io/cloudnative-pg/pgbouncer</code>.</p>
<p>This example shows <code>Pooler</code> specifying `PodAntiAffinity``:</p>
<pre><code class="language-yaml">apiVersion: postgresql.cnpg.io/v1
kind: Pooler
metadata:
  name: pooler-example-rw
spec:
  cluster:
    name: cluster-example
  instances: 3
  type: rw

  template:
    metadata:
      labels:
        app: pooler
    spec:
      containers: []
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - pooler
            topologyKey: &quot;kubernetes.io/hostname&quot;
</code></pre>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Explicitly set <code>.spec.template.spec.containers</code> to <code>[]</code> when not modified,
as it's a required field for a <code>PodSpec</code>. If <code>.spec.template.spec.containers</code>
isn't set, the Kubernetes api-server returns the following error when trying to
apply the manifest:<code>error validating "pooler.yaml": error validating data:
ValidationError(Pooler.spec.template.spec): missing required field
"containers"</code></p>
</div>
<p>This example sets resources and changes the used image:</p>
<pre><code class="language-yaml">apiVersion: postgresql.cnpg.io/v1
kind: Pooler
metadata:
  name: pooler-example-rw
spec:
  cluster:
    name: cluster-example
  instances: 3
  type: rw

  template:
    metadata:
      labels:
        app: pooler
    spec:
      containers:
        - name: pgbouncer
          image: my-pgbouncer:latest
          resources:
            requests:
              cpu: &quot;0.1&quot;
              memory: 100Mi
            limits:
              cpu: &quot;0.5&quot;
              memory: 500Mi
</code></pre>
<h2 id="service-template">Service Template</h2>
<p>Sometimes, your pooler will require some different labels, annotations, or even change
the type of the service, you can achieve that by using the <code>serviceTemplate</code> field:</p>
<pre><code class="language-yaml">apiVersion: postgresql.cnpg.io/v1
kind: Pooler
metadata:
  name: pooler-example-rw
spec:
  cluster:
    name: cluster-example
  instances: 3
  type: rw
  serviceTemplate:
    metadata:
      labels:
        app: pooler
    spec:
      type: LoadBalancer
  pgbouncer:
    poolMode: session
    parameters:
      max_client_conn: &quot;1000&quot;
      default_pool_size: &quot;10&quot;
</code></pre>
<h2 id="high-availability-ha">High availability (HA)</h2>
<p>Because of Kubernetes' deployments, you can configure your pooler to run on a
single instance or over multiple pods. The exposed service makes sure that your
clients are randomly distributed over the available pods running PgBouncer,
which then manages and reuses connections toward the underlying server (if
using the <code>rw</code> service) or servers (if using the <code>ro</code> service with multiple
replicas).</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If your infrastructure spans multiple availability zones with high latency
across them, be aware of network hops. Consider, for example, the case of your
application running in zone 2, connecting to PgBouncer running in zone 3, and
pointing to the PostgreSQL primary in zone 1. </p>
</div>
<h2 id="pgbouncer-configuration-options">PgBouncer configuration options</h2>
<p>The operator manages most of the <a href="https://www.pgbouncer.org/config.html">configuration options for PgBouncer</a>,
allowing you to modify only a subset of them.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>You are responsible for correctly setting the value of each option, as the
operator doesn't validate them.</p>
</div>
<p>These are the PgBouncer options you can customize, with links to the PgBouncer
documentation for each parameter. Unless stated otherwise, the default values
are the ones directly set by PgBouncer.</p>
<ul>
<li><a href="https://www.pgbouncer.org/config.html#application_name_add_host"><code>application_name_add_host</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#autodb_idle_timeout"><code>autodb_idle_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#client_idle_timeout"><code>client_idle_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#client_login_timeout"><code>client_login_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#default_pool_size"><code>default_pool_size</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#disable_pqexec"><code>disable_pqexec</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#idle_transaction_timeout"><code>idle_transaction_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#ignore_startup_parameters"><code>ignore_startup_parameters</code></a>:
  to be appended to <code>extra_float_digits,options</code> - required by CNP</li>
<li><a href="https://www.pgbouncer.org/config.html#log_connections"><code>log_connections</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#log_disconnections"><code>log_disconnections</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#log_pooler_errors"><code>log_pooler_errors</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#log_stats"><code>log_stats</code></a>: by default
  disabled (<code>0</code>), given that statistics are already collected by the Prometheus
  export as described in the <a href="#monitoring">"Monitoring"</a> section below</li>
<li><a href="https://www.pgbouncer.org/config.html#max_client_conn"><code>max_client_conn</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#max_db_connections"><code>max_db_connections</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#max_prepared_statements"><code>max_prepared_statements</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#max_user_connections"><code>max_user_connections</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#min_pool_size"><code>min_pool_size</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#query_timeout"><code>query_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#query_wait_timeout"><code>query_wait_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#reserve_pool_size"><code>reserve_pool_size</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#reserve_pool_timeout"><code>reserve_pool_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_check_delay"><code>server_check_delay</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_check_query"><code>server_check_query</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_connect_timeout"><code>server_connect_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_fast_close"><code>server_fast_close</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_idle_timeout"><code>server_idle_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_lifetime"><code>server_lifetime</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_login_retry"><code>server_login_retry</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_reset_query"><code>server_reset_query</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_reset_query_always"><code>server_reset_query_always</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_round_robin"><code>server_round_robin</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#stats_period"><code>stats_period</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#tcp_keepalive"><code>tcp_keepalive</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#tcp_keepcnt"><code>tcp_keepcnt</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#tcp_keepidle"><code>tcp_keepidle</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#tcp_keepintvl"><code>tcp_keepintvl</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#tcp_user_timeout"><code>tcp_user_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#verbose"><code>verbose</code></a></li>
</ul>
<p>Customizations of the PgBouncer configuration are written declaratively in the
<code>.spec.pgbouncer.parameters</code> map.</p>
<p>The operator reacts to the changes in the pooler specification, and every
PgBouncer instance reloads the updated configuration without disrupting the
service.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Every PgBouncer pod has the same configuration, aligned
with the parameters in the specification. A mistake in these
parameters might disrupt the operability of the whole pooler.
The operator doesn't validate the value of any option.</p>
</div>
<h2 id="monitoring">Monitoring</h2>
<p>The PgBouncer implementation of the <code>Pooler</code> comes with a default
Prometheus exporter. It makes available several
metrics having the <code>cnpg_pgbouncer_</code> prefix by running:</p>
<ul>
<li><code>SHOW LISTS</code> (prefix: <code>cnpg_pgbouncer_lists</code>)</li>
<li><code>SHOW POOLS</code> (prefix: <code>cnpg_pgbouncer_pools</code>)</li>
<li><code>SHOW STATS</code> (prefix: <code>cnpg_pgbouncer_stats</code>)</li>
</ul>
<p>Like the CloudNativePG instance, the exporter runs on port
<code>9127</code> of each pod running PgBouncer and also provides metrics related to the
Go runtime (with the prefix <code>go_*</code>).</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>You can inspect the exported metrics on a pod running PgBouncer. For instructions, see
<a href="../monitoring/#how-to-inspect-the-exported-metrics">How to inspect the exported metrics</a>.
Make sure that you use the correct IP and the <code>9127</code> port.</p>
</div>
<p>This example shows the output for <code>cnpg_pgbouncer</code> metrics:</p>
<pre><code class="language-text"># HELP cnpg_pgbouncer_collection_duration_seconds Collection time duration in seconds
# TYPE cnpg_pgbouncer_collection_duration_seconds gauge
cnpg_pgbouncer_collection_duration_seconds{collector=&quot;Collect.up&quot;} 0.002443168

# HELP cnpg_pgbouncer_collections_total Total number of times PostgreSQL was accessed for metrics.
# TYPE cnpg_pgbouncer_collections_total counter
cnpg_pgbouncer_collections_total 1

# HELP cnpg_pgbouncer_last_collection_error 1 if the last collection ended with error, 0 otherwise.
# TYPE cnpg_pgbouncer_last_collection_error gauge
cnpg_pgbouncer_last_collection_error 0

# HELP cnpg_pgbouncer_lists_databases Count of databases.
# TYPE cnpg_pgbouncer_lists_databases gauge
cnpg_pgbouncer_lists_databases 1

# HELP cnpg_pgbouncer_lists_dns_names Count of DNS names in the cache.
# TYPE cnpg_pgbouncer_lists_dns_names gauge
cnpg_pgbouncer_lists_dns_names 0

# HELP cnpg_pgbouncer_lists_dns_pending Not used.
# TYPE cnpg_pgbouncer_lists_dns_pending gauge
cnpg_pgbouncer_lists_dns_pending 0

# HELP cnpg_pgbouncer_lists_dns_queries Count of in-flight DNS queries.
# TYPE cnpg_pgbouncer_lists_dns_queries gauge
cnpg_pgbouncer_lists_dns_queries 0

# HELP cnpg_pgbouncer_lists_dns_zones Count of DNS zones in the cache.
# TYPE cnpg_pgbouncer_lists_dns_zones gauge
cnpg_pgbouncer_lists_dns_zones 0

# HELP cnpg_pgbouncer_lists_free_clients Count of free clients.
# TYPE cnpg_pgbouncer_lists_free_clients gauge
cnpg_pgbouncer_lists_free_clients 49

# HELP cnpg_pgbouncer_lists_free_servers Count of free servers.
# TYPE cnpg_pgbouncer_lists_free_servers gauge
cnpg_pgbouncer_lists_free_servers 0

# HELP cnpg_pgbouncer_lists_login_clients Count of clients in login state.
# TYPE cnpg_pgbouncer_lists_login_clients gauge
cnpg_pgbouncer_lists_login_clients 0

# HELP cnpg_pgbouncer_lists_pools Count of pools.
# TYPE cnpg_pgbouncer_lists_pools gauge
cnpg_pgbouncer_lists_pools 1

# HELP cnpg_pgbouncer_lists_used_clients Count of used clients.
# TYPE cnpg_pgbouncer_lists_used_clients gauge
cnpg_pgbouncer_lists_used_clients 1

# HELP cnpg_pgbouncer_lists_used_servers Count of used servers.
# TYPE cnpg_pgbouncer_lists_used_servers gauge
cnpg_pgbouncer_lists_used_servers 0

# HELP cnpg_pgbouncer_lists_users Count of users.
# TYPE cnpg_pgbouncer_lists_users gauge
cnpg_pgbouncer_lists_users 2

# HELP cnpg_pgbouncer_pools_cl_active Client connections that are linked to server connection and can process queries.
# TYPE cnpg_pgbouncer_pools_cl_active gauge
cnpg_pgbouncer_pools_cl_active{database=&quot;pgbouncer&quot;,user=&quot;pgbouncer&quot;} 1

# HELP cnpg_pgbouncer_pools_cl_cancel_req Client connections that have not forwarded query cancellations to the server yet.
# TYPE cnpg_pgbouncer_pools_cl_cancel_req gauge
cnpg_pgbouncer_pools_cl_cancel_req{database=&quot;pgbouncer&quot;,user=&quot;pgbouncer&quot;} 0

# HELP cnpg_pgbouncer_pools_cl_waiting Client connections that have sent queries but have not yet got a server connection.
# TYPE cnpg_pgbouncer_pools_cl_waiting gauge
cnpg_pgbouncer_pools_cl_waiting{database=&quot;pgbouncer&quot;,user=&quot;pgbouncer&quot;} 0

# HELP cnpg_pgbouncer_pools_maxwait How long the first (oldest) client in the queue has waited, in seconds. If this starts increasing, then the current pool of servers does not handle requests quickly enough. The reason may be either an overloaded server or just too small of a pool_size setting.
# TYPE cnpg_pgbouncer_pools_maxwait gauge
cnpg_pgbouncer_pools_maxwait{database=&quot;pgbouncer&quot;,user=&quot;pgbouncer&quot;} 0

# HELP cnpg_pgbouncer_pools_maxwait_us Microsecond part of the maximum waiting time.
# TYPE cnpg_pgbouncer_pools_maxwait_us gauge
cnpg_pgbouncer_pools_maxwait_us{database=&quot;pgbouncer&quot;,user=&quot;pgbouncer&quot;} 0

# HELP cnpg_pgbouncer_pools_pool_mode The pooling mode in use. 1 for session, 2 for transaction, 3 for statement, -1 if unknown
# TYPE cnpg_pgbouncer_pools_pool_mode gauge
cnpg_pgbouncer_pools_pool_mode{database=&quot;pgbouncer&quot;,user=&quot;pgbouncer&quot;} 3

# HELP cnpg_pgbouncer_pools_sv_active Server connections that are linked to a client.
# TYPE cnpg_pgbouncer_pools_sv_active gauge
cnpg_pgbouncer_pools_sv_active{database=&quot;pgbouncer&quot;,user=&quot;pgbouncer&quot;} 0

# HELP cnpg_pgbouncer_pools_sv_idle Server connections that are unused and immediately usable for client queries.
# TYPE cnpg_pgbouncer_pools_sv_idle gauge
cnpg_pgbouncer_pools_sv_idle{database=&quot;pgbouncer&quot;,user=&quot;pgbouncer&quot;} 0

# HELP cnpg_pgbouncer_pools_sv_login Server connections currently in the process of logging in.
# TYPE cnpg_pgbouncer_pools_sv_login gauge
cnpg_pgbouncer_pools_sv_login{database=&quot;pgbouncer&quot;,user=&quot;pgbouncer&quot;} 0

# HELP cnpg_pgbouncer_pools_sv_tested Server connections that are currently running either server_reset_query or server_check_query.
# TYPE cnpg_pgbouncer_pools_sv_tested gauge
cnpg_pgbouncer_pools_sv_tested{database=&quot;pgbouncer&quot;,user=&quot;pgbouncer&quot;} 0

# HELP cnpg_pgbouncer_pools_sv_used Server connections that have been idle for more than server_check_delay, so they need server_check_query to run on them before they can be used again.
# TYPE cnpg_pgbouncer_pools_sv_used gauge
cnpg_pgbouncer_pools_sv_used{database=&quot;pgbouncer&quot;,user=&quot;pgbouncer&quot;} 0

# HELP cnpg_pgbouncer_stats_avg_query_count Average queries per second in last stat period.
# TYPE cnpg_pgbouncer_stats_avg_query_count gauge
cnpg_pgbouncer_stats_avg_query_count{database=&quot;pgbouncer&quot;} 1

# HELP cnpg_pgbouncer_stats_avg_query_time Average query duration, in microseconds.
# TYPE cnpg_pgbouncer_stats_avg_query_time gauge
cnpg_pgbouncer_stats_avg_query_time{database=&quot;pgbouncer&quot;} 0

# HELP cnpg_pgbouncer_stats_avg_recv Average received (from clients) bytes per second.
# TYPE cnpg_pgbouncer_stats_avg_recv gauge
cnpg_pgbouncer_stats_avg_recv{database=&quot;pgbouncer&quot;} 0

# HELP cnpg_pgbouncer_stats_avg_sent Average sent (to clients) bytes per second.
# TYPE cnpg_pgbouncer_stats_avg_sent gauge
cnpg_pgbouncer_stats_avg_sent{database=&quot;pgbouncer&quot;} 0

# HELP cnpg_pgbouncer_stats_avg_wait_time Time spent by clients waiting for a server, in microseconds (average per second).
# TYPE cnpg_pgbouncer_stats_avg_wait_time gauge
cnpg_pgbouncer_stats_avg_wait_time{database=&quot;pgbouncer&quot;} 0

# HELP cnpg_pgbouncer_stats_avg_xact_count Average transactions per second in last stat period.
# TYPE cnpg_pgbouncer_stats_avg_xact_count gauge
cnpg_pgbouncer_stats_avg_xact_count{database=&quot;pgbouncer&quot;} 1

# HELP cnpg_pgbouncer_stats_avg_xact_time Average transaction duration, in microseconds.
# TYPE cnpg_pgbouncer_stats_avg_xact_time gauge
cnpg_pgbouncer_stats_avg_xact_time{database=&quot;pgbouncer&quot;} 0

# HELP cnpg_pgbouncer_stats_total_query_count Total number of SQL queries pooled by pgbouncer.
# TYPE cnpg_pgbouncer_stats_total_query_count gauge
cnpg_pgbouncer_stats_total_query_count{database=&quot;pgbouncer&quot;} 3

# HELP cnpg_pgbouncer_stats_total_query_time Total number of microseconds spent by pgbouncer when actively connected to PostgreSQL, executing queries.
# TYPE cnpg_pgbouncer_stats_total_query_time gauge
cnpg_pgbouncer_stats_total_query_time{database=&quot;pgbouncer&quot;} 0

# HELP cnpg_pgbouncer_stats_total_received Total volume in bytes of network traffic received by pgbouncer.
# TYPE cnpg_pgbouncer_stats_total_received gauge
cnpg_pgbouncer_stats_total_received{database=&quot;pgbouncer&quot;} 0

# HELP cnpg_pgbouncer_stats_total_sent Total volume in bytes of network traffic sent by pgbouncer.
# TYPE cnpg_pgbouncer_stats_total_sent gauge
cnpg_pgbouncer_stats_total_sent{database=&quot;pgbouncer&quot;} 0

# HELP cnpg_pgbouncer_stats_total_wait_time Time spent by clients waiting for a server, in microseconds.
# TYPE cnpg_pgbouncer_stats_total_wait_time gauge
cnpg_pgbouncer_stats_total_wait_time{database=&quot;pgbouncer&quot;} 0

# HELP cnpg_pgbouncer_stats_total_xact_count Total number of SQL transactions pooled by pgbouncer.
# TYPE cnpg_pgbouncer_stats_total_xact_count gauge
cnpg_pgbouncer_stats_total_xact_count{database=&quot;pgbouncer&quot;} 3

# HELP cnpg_pgbouncer_stats_total_xact_time Total number of microseconds spent by pgbouncer when connected to PostgreSQL in a transaction, either idle in transaction or executing queries.
# TYPE cnpg_pgbouncer_stats_total_xact_time gauge
cnpg_pgbouncer_stats_total_xact_time{database=&quot;pgbouncer&quot;} 0
</code></pre>
<p>As for clusters, a specific pooler can be monitored using the
<a href="https://github.com/prometheus-operator/prometheus-operator">Prometheus operator's</a> resource
<a href="https://github.com/prometheus-operator/prometheus-operator/blob/v0.47.1/Documentation/api.md#podmonitor">PodMonitor</a>.
A <code>PodMonitor</code> correctly pointing to a pooler can be created by the operator by setting
<code>.spec.monitoring.enablePodMonitor</code> to <code>true</code> in the <code>Pooler</code> resource. The default is <code>false</code>.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Any change to <code>PodMonitor</code> created automatically is overridden by the
operator at the next reconciliation cycle. If you need to customize it, you can
do so as shown in the following example.</p>
</div>
<p>To deploy a <code>PodMonitor</code> for a specific pooler manually, you can define it as
follows and change it as needed:</p>
<pre><code class="language-yaml">apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: &lt;POOLER_NAME&gt;
spec:
  selector:
    matchLabels:
      cnpg.io/poolerName: &lt;POOLER_NAME&gt;
  podMetricsEndpoints:
  - port: metrics
</code></pre>
<h2 id="logging">Logging</h2>
<p>Logs are directly sent to standard output, in JSON format, like in the
following example:</p>
<pre><code class="language-json">{
  &quot;level&quot;: &quot;info&quot;,
  &quot;ts&quot;: SECONDS.MICROSECONDS,
  &quot;msg&quot;: &quot;record&quot;,
  &quot;pipe&quot;: &quot;stderr&quot;,
  &quot;record&quot;: {
    &quot;timestamp&quot;: &quot;YYYY-MM-DD HH:MM:SS.MS UTC&quot;,
    &quot;pid&quot;: &quot;&lt;PID&gt;&quot;,
    &quot;level&quot;: &quot;LOG&quot;,
    &quot;msg&quot;: &quot;kernel file descriptor limit: 1048576 (hard: 1048576); max_client_conn: 100, max expected fd use: 112&quot;
  }
}
</code></pre>
<h2 id="pausing-connections">Pausing connections</h2>
<p>The <code>Pooler</code> specification allows you to take advantage of PgBouncer's <code>PAUSE</code>
and <code>RESUME</code> commands, using only declarative configuration. You can ado this
using the <code>paused</code> option, which by default is set to <code>false</code>. When set to
<code>true</code>, the operator internally invokes the <code>PAUSE</code> command in PgBouncer,
which:</p>
<ol>
<li>Closes all active connections toward the PostgreSQL server, after waiting
   for the queries to complete</li>
<li>Pauses any new connection coming from the client</li>
</ol>
<p>When the <code>paused</code> option is reset to <code>false</code>, the operator invokes the
<code>RESUME</code> command in PgBouncer, reopening the taps toward the PostgreSQL
service defined in the <code>Pooler</code> resource.</p>
<div class="admonition seealso">
<p class="admonition-title">PAUSE</p>
<p>For more information, see
<a href="https://www.pgbouncer.org/usage.html#pause-db"><code>PAUSE</code> in the PgBouncer documentation</a>.</p>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>In future versions, the switchover operation will be fully integrated
with the PgBouncer pooler and take advantage of the <code>PAUSE</code>/<code>RESUME</code>
features to reduce the perceived downtime by client applications.
Currently, you can achieve the same results by setting the <code>paused</code>
attribute to <code>true</code>, issuing the switchover command through the
<a href="../kubectl-plugin/#promote"><code>cnpg</code> plugin</a>, and then restoring the <code>paused</code>
attribute to <code>false</code>.</p>
</div>
<h2 id="limitations">Limitations</h2>
<h3 id="single-postgresql-cluster">Single PostgreSQL cluster</h3>
<p>The current implementation of the pooler is designed to work as part of a
specific CloudNativePG cluster (a service). It isn't currently possible to
create a pooler that spans multiple clusters.</p>
<h3 id="controlled-configurability">Controlled configurability</h3>
<p>CloudNativePG transparently manages several configuration options that are used
for the PgBouncer layer to communicate with PostgreSQL. Such options aren't
configurable from outside and include TLS certificates, authentication
settings, the <code>databases</code> section, and the <code>users</code> section. Also, considering
the specific use case for the single PostgreSQL cluster, the adopted criteria
is to explicitly list the options that can be configured by users.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The adopted solution likely addresses the majority of
use cases. It leaves room for the future implementation of a separate
operator for PgBouncer to complete the gamma with more advanced and customized
scenarios.</p>
</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../applications/" class="btn btn-neutral float-left" title="Connecting from an application"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../replica_cluster/" class="btn btn-neutral float-right" title="Replica clusters">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../applications/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../replica_cluster/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
