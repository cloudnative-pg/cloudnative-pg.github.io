<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="The CloudNativePG Contributors" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Logging - CloudNativePG v1.22</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/override.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Logging";
        var mkdocs_page_input_path = "logging.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> CloudNativePG v1.22
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">CloudNativePG</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../before_you_start/">Before You Start</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../use_cases/">Use cases</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../architecture/">Architecture</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../installation_upgrade/">Installation and upgrades</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../quickstart/">Quickstart</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../image_catalog/">Image Catalog</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../bootstrap/">Bootstrap</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../database_import/">Importing Postgres databases</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../security/">Security</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../instance_manager/">Postgres instance manager</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../scheduling/">Scheduling</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../resource_management/">Resource management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../failure_modes/">Failure Modes</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../rolling_update/">Rolling Updates</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../replication/">Replication</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../backup/">Backup</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../backup_barmanobjectstore/">Backup on object stores</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../wal_archiving/">WAL archiving</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../backup_volumesnapshot/">Backup on volume snapshots</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../recovery/">Recovery</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../service_management/">Service Management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../postgresql_conf/">PostgreSQL Configuration</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../declarative_role_management/">Database Role Management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../tablespaces/">Tablespaces</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../operator_conf/">Operator configuration</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../cluster_conf/">Instance pod configuration</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../storage/">Storage</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../labels_annotations/">Labels and annotations</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../monitoring/">Monitoring</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="./">Logging</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#operator-log">Operator log</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#postgresql-log">PostgreSQL log</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#pgaudit-logs">PGAudit logs</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#other-logs">Other logs</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../certificates/">Certificates</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../ssl_connections/">Client TLS/SSL connections</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../applications/">Connecting from an application</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../connection_pooling/">Connection pooling</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../replica_cluster/">Replica clusters</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../kubernetes_upgrade/">Kubernetes Upgrade and Maintenance</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../kubectl-plugin/">Kubectl Plugin</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../failover/">Automated failover</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../troubleshooting/">Troubleshooting</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../fencing/">Fencing</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../declarative_hibernation/">Declarative hibernation</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../postgis/">PostGIS</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../e2e/">End-to-End Tests</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../container_images/">Container Image Requirements</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../operator_capability_levels/">Operator capability levels</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../controller/">Custom Pod Controller</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../samples/">Examples</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../networking/">Networking</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../benchmarking/">Benchmarking</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../commercial_support/">Commercial support</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../faq/">Frequently Asked Questions (FAQ)</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../cloudnative-pg.v1/">API Reference</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../supported_releases/">Supported releases</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../preview_version/">Preview Versions</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../release_notes/">Release notes</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Appendixes</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../appendixes/object_stores/">Appendix A - Common object stores for backups</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">CloudNativePG v1.22</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Logging</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="logging">Logging</h1>
<p>The operator is designed to log in JSON format directly to standard output,
including PostgreSQL logs.</p>
<p>Each log entry has the following fields:</p>
<ul>
<li><code>level</code> – Log level (<code>info</code>, <code>notice</code>, ...).</li>
<li><code>ts</code> – The timestamp (epoch with microseconds).</li>
<li><code>logger</code> – The type of the record (for example, <code>postgres</code> or <code>pg_controldata</code>).</li>
<li><code>msg</code> – The actual message or the keyword <code>record</code> in case the message is parsed in JSON format.</li>
<li><code>record</code> – The actual record with structure that varies depending on the
  <code>logger</code> type.</li>
<li><code>logging_podName</code> – The pod where the log was created.</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Long-term storage and management of logs is outside the operator's purview,
and needs to be provided at the level of the Kubernetes installation.
See the
<a href="https://kubernetes.io/docs/concepts/cluster-administration/logging/">Kubernetes Logging Architecture</a>
documentation.</p>
</div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>If your log ingestion system requires it, you can rename the <code>level</code> and <code>ts</code> field names using the <code>log-field-level</code> and
<code>log-field-timestamp</code> flags of the operator controller. Edit the <code>Deployment</code> definition of the
<code>cloudnative-pg</code> operator.</p>
</div>
<h2 id="operator-log">Operator log</h2>
<p>You can specify a log level in the cluster spec with the option <code>logLevel</code>.
You can set it to <code>error</code>, <code>warning</code>, <code>info</code>(default), <code>debug</code>, or <code>trace</code>.</p>
<p>Currently, you can set the log level only when an instance starts. You can't
change it at runtime. If you change the value in the cluster spec after the cluster
was started, it takes effect only in the new pods and not the old ones.</p>
<h2 id="postgresql-log">PostgreSQL log</h2>
<p>Each entry in the PostgreSQL log is a JSON object having the <code>logger</code> key set
to <code>postgres</code> and the structure described in the following example:</p>
<pre><code class="language-json">{
  &quot;level&quot;: &quot;info&quot;,
  &quot;ts&quot;: 1619781249.7188137,
  &quot;logger&quot;: &quot;postgres&quot;,
  &quot;msg&quot;: &quot;record&quot;,
  &quot;record&quot;: {
    &quot;log_time&quot;: &quot;2021-04-30 11:14:09.718 UTC&quot;,
    &quot;user_name&quot;: &quot;&quot;,
    &quot;database_name&quot;: &quot;&quot;,
    &quot;process_id&quot;: &quot;25&quot;,
    &quot;connection_from&quot;: &quot;&quot;,
    &quot;session_id&quot;: &quot;608be681.19&quot;,
    &quot;session_line_num&quot;: &quot;1&quot;,
    &quot;command_tag&quot;: &quot;&quot;,
    &quot;session_start_time&quot;: &quot;2021-04-30 11:14:09 UTC&quot;,
    &quot;virtual_transaction_id&quot;: &quot;&quot;,
    &quot;transaction_id&quot;: &quot;0&quot;,
    &quot;error_severity&quot;: &quot;LOG&quot;,
    &quot;sql_state_code&quot;: &quot;00000&quot;,
    &quot;message&quot;: &quot;database system was interrupted; last known up at 2021-04-30 11:14:07 UTC&quot;,
    &quot;detail&quot;: &quot;&quot;,
    &quot;hint&quot;: &quot;&quot;,
    &quot;internal_query&quot;: &quot;&quot;,
    &quot;internal_query_pos&quot;: &quot;&quot;,
    &quot;context&quot;: &quot;&quot;,
    &quot;query&quot;: &quot;&quot;,
    &quot;query_pos&quot;: &quot;&quot;,
    &quot;location&quot;: &quot;&quot;,
    &quot;application_name&quot;: &quot;&quot;,
    &quot;backend_type&quot;: &quot;startup&quot;
  },
  &quot;logging_pod&quot;: &quot;cluster-example-1&quot;,
}
</code></pre>
<p>Internally, the operator relies on the PostgreSQL CSV log format. See
the PostgreSQL documentation for more information about the <a href="https://www.postgresql.org/docs/current/runtime-config-logging.html">CSV log
format</a>.</p>
<h2 id="pgaudit-logs">PGAudit logs</h2>
<p>CloudNativePG has transparent and native support for
<a href="https://www.pgaudit.org/">PGAudit</a> on PostgreSQL clusters.</p>
<p>To enable this support, add the required <code>pgaudit</code> parameters to the <code>postgresql</code>
section in the configuration of the cluster.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>You need to add the PGAudit library to <code>shared_preload_libraries</code>.
CloudNativePG adds the library based on the
presence of <code>pgaudit.*</code> parameters in the postgresql configuration.
The operator detects and manages the addition and removal of the
library from <code>shared_preload_libraries</code>.</p>
</div>
<p>The operator also takes care of creating and removing the extension from all
the available databases in the cluster.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>CloudNativePG runs the <code>CREATE EXTENSION</code> and
<code>DROP EXTENSION</code> commands in all databases in the cluster that accept
connections.</p>
</div>
<p>This example shows a PostgreSQL 13 <code>Cluster</code> deployment that results in
<code>pgaudit</code> being enabled with the requested configuration:</p>
<pre><code class="language-yaml">apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: cluster-example
spec:
  instances: 3
  imageName: ghcr.io/cloudnative-pg/postgresql:13

  postgresql:
    parameters:
      &quot;pgaudit.log&quot;: &quot;all, -misc&quot;
      &quot;pgaudit.log_catalog&quot;: &quot;off&quot;
      &quot;pgaudit.log_parameter&quot;: &quot;on&quot;
      &quot;pgaudit.log_relation&quot;: &quot;on&quot;

  storage:
    size: 1Gi
</code></pre>
<p>The audit CSV logs entries returned by PGAudit are then parsed and routed to
stdout in JSON format, similarly to all the remaining logs:</p>
<ul>
<li><code>.logger</code> is set to <code>pgaudit</code>.</li>
<li><code>.msg</code> is set to <code>record</code>.</li>
<li><code>.record</code> contains the whole parsed record as a JSON object. This is similar to
  <code>logging_collector</code> logs, except for <code>.record.audit</code>, which contains the
  PGAudit CSV message formatted as a JSON object.</li>
</ul>
<p>This example shows sample log entries:</p>
<pre><code class="language-json">{
  &quot;level&quot;: &quot;info&quot;,
  &quot;ts&quot;: 1627394507.8814096,
  &quot;logger&quot;: &quot;pgaudit&quot;,
  &quot;msg&quot;: &quot;record&quot;,
  &quot;record&quot;: {
    &quot;log_time&quot;: &quot;2021-07-27 14:01:47.881 UTC&quot;,
    &quot;user_name&quot;: &quot;postgres&quot;,
    &quot;database_name&quot;: &quot;postgres&quot;,
    &quot;process_id&quot;: &quot;203&quot;,
    &quot;connection_from&quot;: &quot;[local]&quot;,
    &quot;session_id&quot;: &quot;610011cb.cb&quot;,
    &quot;session_line_num&quot;: &quot;1&quot;,
    &quot;command_tag&quot;: &quot;SELECT&quot;,
    &quot;session_start_time&quot;: &quot;2021-07-27 14:01:47 UTC&quot;,
    &quot;virtual_transaction_id&quot;: &quot;3/336&quot;,
    &quot;transaction_id&quot;: &quot;0&quot;,
    &quot;error_severity&quot;: &quot;LOG&quot;,
    &quot;sql_state_code&quot;: &quot;00000&quot;,
    &quot;backend_type&quot;: &quot;client backend&quot;,
    &quot;audit&quot;: {
      &quot;audit_type&quot;: &quot;SESSION&quot;,
      &quot;statement_id&quot;: &quot;1&quot;,
      &quot;substatement_id&quot;: &quot;1&quot;,
      &quot;class&quot;: &quot;READ&quot;,
      &quot;command&quot;: &quot;SELECT FOR KEY SHARE&quot;,
      &quot;statement&quot;: &quot;SELECT pg_current_wal_lsn()&quot;,
      &quot;parameter&quot;: &quot;&lt;none&gt;&quot;
    }
  },
  &quot;logging_pod&quot;: &quot;cluster-example-1&quot;,
}
</code></pre>
<p>See the
<a href="https://github.com/pgaudit/pgaudit/blob/master/README.md#format">PGAudit documentation</a> <!-- wokeignore:rule=master -->
for more details about each field in a record.</p>
<h2 id="other-logs">Other logs</h2>
<p>All logs that are produced by the operator and its instances are in JSON
format, with <code>logger</code> set according to the process that produced them.
Therefore, all the possible <code>logger</code> values are the following:</p>
<ul>
<li><code>barman-cloud-wal-archive</code>: from <code>barman-cloud-wal-archive</code> directly</li>
<li><code>barman-cloud-wal-restore</code>: from <code>barman-cloud-wal-restore</code> directly</li>
<li><code>initdb</code>: from running <code>initdb</code></li>
<li><code>pg_basebackup</code>: from running <code>pg_basebackup</code></li>
<li><code>pg_controldata</code>: from running <code>pg_controldata</code></li>
<li><code>pg_ctl</code>: from running any <code>pg_ctl</code> subcommand</li>
<li><code>pg_rewind</code>: from running <code>pg_rewind</code></li>
<li><code>pgaudit</code>: from PGAudit extension</li>
<li><code>postgres</code>: from the <code>postgres</code> instance (having <code>msg</code> different than <code>record</code>)</li>
<li><code>wal-archive</code>: from the <code>wal-archive</code> subcommand of the instance manager</li>
<li><code>wal-restore</code>: from the <code>wal-restore</code> subcommand of the instance manager</li>
</ul>
<p>Except for <code>postgres</code>, which has the aforementioned structures,
all other possible values have <code>msg</code> set to the escaped message that's
logged.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../monitoring/" class="btn btn-neutral float-left" title="Monitoring"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../certificates/" class="btn btn-neutral float-right" title="Certificates">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../monitoring/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../certificates/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
