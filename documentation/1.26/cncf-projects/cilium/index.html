<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="The CloudNativePG Contributors" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Cilium - CloudNativePG v1.26</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../css/override.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Cilium";
        var mkdocs_page_input_path = "cncf-projects/cilium.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> CloudNativePG v1.26
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">CloudNativePG</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../before_you_start/">Before You Start</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../use_cases/">Use cases</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../architecture/">Architecture</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../installation_upgrade/">Installation and upgrades</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../quickstart/">Quickstart</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../image_catalog/">Image Catalog</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../bootstrap/">Bootstrap</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../database_import/">Importing Postgres databases</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../security/">Security</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../instance_manager/">Postgres instance manager</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../scheduling/">Scheduling</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../resource_management/">Resource management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../failure_modes/">Failure Modes</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../rolling_update/">Rolling Updates</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../replication/">Replication</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../logical_replication/">Logical Replication</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../backup/">Backup</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../wal_archiving/">WAL archiving</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../recovery/">Recovery</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../service_management/">Service Management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../postgresql_conf/">PostgreSQL Configuration</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../declarative_role_management/">PostgreSQL Role Management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../declarative_database_management/">PostgreSQL Database Management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../tablespaces/">Tablespaces</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../operator_conf/">Operator configuration</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../cluster_conf/">Instance pod configuration</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../storage/">Storage</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../labels_annotations/">Labels and annotations</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../monitoring/">Monitoring</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../logging/">Logging</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../certificates/">Certificates</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../ssl_connections/">Client TLS/SSL connections</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../applications/">Connecting from an application</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../connection_pooling/">Connection pooling</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../replica_cluster/">Replica clusters</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../kubernetes_upgrade/">Kubernetes Upgrade and Maintenance</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../postgres_upgrades/">PostgreSQL Upgrades</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../kubectl-plugin/">Kubectl Plugin</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../failover/">Automated failover</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../troubleshooting/">Troubleshooting</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../fencing/">Fencing</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../declarative_hibernation/">Declarative hibernation</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../postgis/">PostGIS</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../e2e/">End-to-End Tests</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../container_images/">Container Image Requirements</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../cnpg_i/">CNPG-I</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../operator_capability_levels/">Operator capability levels</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../controller/">Custom Pod Controller</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../samples/">Examples</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../networking/">Networking</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../benchmarking/">Benchmarking</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../faq/">Frequently Asked Questions (FAQ)</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../cloudnative-pg.v1/">API Reference</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../supported_releases/">Supported releases</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../preview_version/">Preview Versions</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../release_notes/">Release notes</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">CNCF Projects Integrations</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../external-secrets/">External Secrets</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Cilium</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#about">About</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#pod-to-pod-network-security-with-cloudnativepg-and-cilium">Pod-to-Pod Network Security with CloudNativePG and Cilium</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#default-deny-behavior-in-cilium">Default Deny Behavior in Cilium</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#making-cilium-network-policies-work-with-cloudnativepg-operator">Making Cilium Network Policies work with CloudNativePG Operator</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#allowing-access-between-cluster-pods">Allowing access between cluster Pods</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#restricting-access-to-postgresql-with-cilium">Restricting Access to PostgreSQL with Cilium</a>
    </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Appendixes</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../appendixes/backup_volumesnapshot/">Appendix A - Backup on volume snapshots</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../appendixes/backup_barmanobjectstore/">Appendix B - Backup on object stores</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../appendixes/object_stores/">Appendix C - Common object stores for backups</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">CloudNativePG v1.26</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">CNCF Projects Integrations</li>
      <li class="breadcrumb-item active">Cilium</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="cilium">Cilium</h1>
<h2 id="about">About</h2>
<p><a href="https://cilium.io/">Cilium</a> is a CNCF Graduated project that was accepted as
an Incubating project in 2021 and graduated in 2023. It was originally created
by Isovalent. It is an advanced networking, security, and observability
solution for cloud native environments, built on top of
<a href="https://ebpf.io/">eBPF</a> technology. Cilium manages network traffic in
Kubernetes clusters by dynamically injecting eBPF programs into the Linux
Kernel, enabling low-latency, high-performance communication, and enforcing
fine-grained security policies.</p>
<p>Key features of Cilium:</p>
<ul>
<li>Advanced L3-L7 security policies for fine-grained network traffic control</li>
<li>Efficient, kernel-level traffic management via eBPF</li>
<li>Service Mesh integration (Cilium Service Mesh)</li>
<li>Support for both Kubernetes NetworkPolicy and CiliumNetworkPolicy</li>
<li>Built-in observability and monitoring with Hubble</li>
</ul>
<p>To install Cilium in your environment, follow the instructions in the documentation:
<a href="https://docs.cilium.io/en/stable/gettingstarted/k8s-install-default/">https://docs.cilium.io/en/stable/gettingstarted/k8s-install-default/</a></p>
<h2 id="pod-to-pod-network-security-with-cloudnativepg-and-cilium">Pod-to-Pod Network Security with CloudNativePG and Cilium</h2>
<p>Kubernetes’ default behavior is to allow traffic between any two Pods in the cluster network.
Cilium provides advanced L3/L4 network security using the <code>CiliumNetworkPolicy</code> resource. This
enables fine-grained control over network traffic between Pods within a Kubernetes cluster. It is
especially useful for securing communication between application workloads and backend
services.</p>
<p>In the following examples, we demonstrate how Cilium can be used to secure a
CloudNativePG PostgreSQL instance by restricting ingress traffic to only
authorized Pods.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Before proceeding, ensure that the <code>cluster-example</code> Postgres cluster is up
and running in your environment.</p>
</div>
<h2 id="default-deny-behavior-in-cilium">Default Deny Behavior in Cilium</h2>
<p>By default, Cilium does <strong>not</strong> deny all traffic unless explicitly configured
to do so. In contrast to Kubernetes NetworkPolicy, which uses a deny-by-default
model once a policy is present in a namespace, Cilium provides more flexible
control over default deny behavior.</p>
<p>To enforce a default deny posture with Cilium, you need to explicitly create a
policy that denies all traffic to a set of Pods unless otherwise allowed. This
is commonly achieved by using an <strong>empty <code>ingress</code> section</strong> in combination
with <code>endpointSelector</code>, or by enabling <strong><code>--enable-default-deny</code></strong> at the
Cilium agent level for broader enforcement.</p>
<p>A minimal example of a default deny policy:</p>
<pre><code class="language-yaml">apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: default-deny
  namespace: default
spec:
  description: &quot;Default deny all ingress traffic to all Pods in this namespace&quot;
  endpointSelector: {}
  ingress: []
</code></pre>
<h2 id="making-cilium-network-policies-work-with-cloudnativepg-operator">Making Cilium Network Policies work with CloudNativePG Operator</h2>
<p>When working with a network policy, Cilium or not, the first step is to make
sure that the operator can reach the Pods in the target namespace. This is
important because the operator needs to be able to perform checks and actions
on the Pods, and one of those actions requires access to the port <code>8000</code> on the
Pods to get the current status of the PostgreSQL instance running inside.</p>
<p>The following <code>CiliumNetworkPolicy</code> allows the operator to access the Pods in
the target <code>default</code> namespace:</p>
<pre><code class="language-yaml">apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: cnpg-operator-access
  namespace: default
spec:
  description: &quot;Allow CloudNativePG operator access to any pod in the target namespace&quot;
  endpointSelector: {}
  ingress:
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: cnpg-system
      toPorts:
        - ports:
            - port: &quot;8000&quot;
              protocol: TCP
</code></pre>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The <code>cnpg-system</code> namespace is the default namespace for the operator when
using the YAML manifests. If the operator was installed using a different
process (Helm, OLM, etc.), the namespace may be different. Make sure to adjust
the namespace properly.</p>
</div>
<h2 id="allowing-access-between-cluster-pods">Allowing access between cluster Pods</h2>
<p>Since the default policy is "deny all", we need to explicitly allow access
between the cluster Pods in the same namespace. We will improve our previous
policy by adding the required ingress rule:</p>
<pre><code class="language-yaml">apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: cnpg-cluster-internal-access
  namespace: default
spec:
  description: &quot;Allow CloudNativePG operator access and connection between pods in the same namespace&quot;
  endpointSelector: {}
  ingress:
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: cnpg-system
        - matchLabels:
            io.kubernetes.pod.namespace: default
            cnpg.io/cluster: cluster-example
      toPorts:
        - ports:
            - port: &quot;8000&quot;
              protocol: TCP
            - port: &quot;5432&quot;
              protocol: TCP
</code></pre>
<p>The policy allows access from <code>cnpg-system</code> Pods and from <code>default</code> namespace
Pods that also belong to <code>cluster-example</code>. The <code>matchLabels</code> selector requires
Pods to have the complete set of listed labels. Missing even one label means
the Pod will not match.</p>
<h2 id="restricting-access-to-postgresql-with-cilium">Restricting Access to PostgreSQL with Cilium</h2>
<p>In this example, we define a <code>CiliumNetworkPolicy</code> that allows only Pods
labeled <code>role=backend</code> in the <code>default</code> namespace to connect to a PostgreSQL
cluster named <code>cluster-example</code>. All other ingress traffic is blocked by
default.</p>
<pre><code class="language-yaml">apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: postgres-access-backend-label
  namespace: default
spec:
  description: &quot;Allow PostgreSQL access on port 5432 from Pods with role=backend&quot;
  endpointSelector:
    matchLabels:
      cnpg.io/cluster: cluster-example
  ingress:
    - fromEndpoints:
       - matchLabels:
            role: backend
      toPorts:
        - ports:
          - port: &quot;5432&quot;
            protocol: TCP
</code></pre>
<p>This <code>CiliumNetworkPolicy</code> ensures that only Pods labeled with <code>role=backend</code>
can access the PostgreSQL instance managed by CloudNativePG via port 5432 in
the <code>default</code> namespace.</p>
<p>In the following policy, we demonstrate how to allow ingress traffic to port
5432 of a PostgreSQL cluster named <code>cluster-example</code>, only from Pods with the
label <code>role=backend</code> in any namespace.</p>
<pre><code class="language-yaml">apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: postgres-access-backend-any-ns
  namespace: default
spec:
  description: &quot;Allow PostgreSQL access on port 5432 from Pods with role=backend in any namespace&quot;
  endpointSelector:
    matchLabels:
      cnpg.io/cluster: cluster-example
  ingress:
    - fromEndpoints:
        - labelSelector:
            matchLabels:
              role: backend
            matchExpressions:
              - key: io.kubernetes.pod.namespace
                operator: Exists
      toPorts:
        - ports:
          - port: &quot;5432&quot;
            protocol: TCP
</code></pre>
<p>The following example allows ingress traffic to port 5432 of the
<code>cluster-example</code> cluster (located in the <code>default</code> namespace) from any Pods in
the <code>backend</code> namespace.</p>
<pre><code class="language-yaml">apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: postgres-access-backend-namespace
  namespace: default
spec:
  description: &quot;Allow PostgreSQL access on port 5432 from any Pods in the backend namespace&quot;
  endpointSelector:
    matchLabels:
      cnpg.io/cluster: cluster-example
  ingress:
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: backend
      toPorts:
        - ports:
            - port: &quot;5432&quot;
              protocol: TCP
</code></pre>
<p>Using Cilium’s L3/L4 policy model, we define a <code>CiliumNetworkPolicy</code> that
explicitly allows ingress traffic to cluster Pods only from application Pods in
the <code>backend</code> namespace. All other traffic is implicitly denied unless
explicitly permitted by additional policies.</p>
<p>The following example allows ingress traffic to port 5432 of the
<code>cluster-example</code> cluster (located in the <code>default</code> namespace) from any source
within the Kubernetes cluster.</p>
<pre><code class="language-yaml">apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: postgres-access-cluster-wide
  namespace: default
spec:
  description: &quot;Allow ingress traffic to port 5432 of the cluster-example from any pods within the Kubernetes cluster&quot;
  endpointSelector:
    matchLabels:
      cnpg.io/cluster: cluster-example
  ingress:
    - fromEntities:
        - cluster
      toPorts:
        - ports:
            - port: &quot;5432&quot;
              protocol: TCP
</code></pre>
<p>You may consider using <a href="https://editor.networkpolicy.io/">editor.networkpolicy.io</a>,
a visual and interactive tool that simplifies the creation and validation of
Cilium Network Policies. It’s especially helpful for avoiding misconfigurations
and understanding traffic rules more clearly by presenting in a visual way.</p>
<p>With these policies, you've established baseline access controls for
PostgreSQL. You can layer additional egress or audit rules using Cilium's
policy language or extend to L7 enforcement with Envoy.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../external-secrets/" class="btn btn-neutral float-left" title="External Secrets"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../../appendixes/backup_volumesnapshot/" class="btn btn-neutral float-right" title="Appendix A - Backup on volume snapshots">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>Copyright © CloudNativePG a Series of LF Projects, LLC</p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../external-secrets/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../appendixes/backup_volumesnapshot/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
